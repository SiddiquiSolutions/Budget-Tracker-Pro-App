<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            font-family: 'Poppins', sans-serif; /* Default font for English */
            background-color: #f0f4f8; /* Default light mode background */
            color: #1a202c; /* Default light mode text */
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh; /* Ensure body takes at least full viewport height */
            display: flex;
            flex-direction: column;
        }
        .dark body {
            background-color: #1a202c; /* Dark mode background */
            color: #e2e8f0; /* Dark mode text */
        }

        /* Removed Urdu Text Styles */
        /*
        .urdu-text {
            font-family: 'Jameel Noori Nastaleeq', 'Poppins', sans-serif;
            display: none;
        }
        body.lang-ur .urdu-text {
            display: inline;
        }
         body.lang-ur .english-text {
             display: none;
         }
         */


         /* Style for Auth Container to center it */
         .auth-container {
             flex-grow: 1; /* Allow auth container to take up available space */
             display: flex;
             justify-content: center;
             align-items: center;
             padding: 1rem; /* Add some padding */
         }

        .glass-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-card {
            background: rgba(26, 32, 44, 0.5);
            border: 1px solid rgba(26, 32, 44, 0.7);
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f0f4f8; /* Match body background */
            padding-top: 1rem;
            padding-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
         .dark .sticky-header {
             background-color: #1a202c; /* Match dark body background */
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
         }
        .nav-button.active {
            @apply bg-blue-600 text-white;
        }
        /* Ensure canvas containers allow flexibility */
        .chart-container {
             position: relative; /* Needed for Chart.js responsiveness */
             width: 100%;
             height: 300px; /* Set a default height, Chart.js will try to be responsive */
        }
        canvas {
            max-width: 100%; /* Ensure canvas is responsive */
            height: 100%; /* Fill container height */
        }
        /* Basic Dark Mode Toggle Switch CSS */
        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }

        /* Hide default HTML checkbox */
        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        /* The slider */
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          -webkit-transition: .4s;
          transition: .4s;
        }

        .dark .slider {
             background-color: #4a5568; /* Darker gray for dark mode slider */
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          -webkit-transition: .4s;
          transition: .4s;
        }

        input:checked + .slider {
          background-color: #2196F3;
        }

        .dark input:checked + .slider {
             background-color: #63b3ed; /* Lighter blue for dark mode checked slider */
        }


        input:focus + .slider {
          box-shadow: 0 0 1px #2196F3;
        }

         .dark input:focus + .slider {
             box-shadow: 0 0 1px #63b3ed;
         }


        input:checked + .slider:before {
          -webkit-transform: translateX(26px);
          -ms-transform: translateX(26px);
          transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
          border-radius: 34px;
        }

        .slider.round:before {
          border-radius: 50%;
        }

        /* Style for inline edit inputs/selects */
        .inline-edit-field {
            padding: 0.25rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: #fff;
            color: #1a202c;
            width: 100%; /* Make inputs fill the cell */
            box-sizing: border-box; /* Include padding and border in element's total width */
        }
         .dark .inline-edit-field {
             background-color: #4a5568;
             border-color: #4a5568;
             color: #e2e8f0;
         }
         .inline-edit-field:focus {
             outline: none;
             border-color: #3182ce; /* Blue focus ring */
             box-shadow: 0 0 0 1px #3182ce;
         }

         /* Style for password container with eye icon */
         .password-container {
             position: relative;
             width: 100%;
         }
         .password-container input {
             padding-right: 2.5rem; /* Make space for the icon */
         }
         .toggle-password {
             position: absolute;
             top: 50%;
             right: 0.75rem;
             transform: translateY(-50%);
             cursor: pointer;
             color: #a0aec0; /* Gray icon color */
         }
          .dark .toggle-password {
              color: #718096; /* Darker gray icon color */
          }

        /* Removed Language Switcher Styles */
        /*
        #language-switcher {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 50;
        }

        #language-select {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #ccc;
            background-color: #fff;
            color: #1a202c;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark #language-select {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }

        #language-select:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 1px #3182ce;
        }
        */


    </style>
</head>
<body class="p-4">

    <div id="auth-container" class="auth-container">
        <section id="login-section" class="auth-section max-w-sm mx-auto glass-card p-6">
            <h2 class="text-2xl font-semibold mb-6 text-center">
                <span class="english-text">Login</span>
                </h2>
            <div class="mb-4">
                <label for="login-username" class="block text-sm font-medium mb-2">
                    <span class="english-text">Username:</span>
                    </label>
                <input type="text" id="login-username" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter your username">
            </div>
            <div class="mb-6">
                <label for="login-password" class="block text-sm font-medium mb-2">
                    <span class="english-text">Password:</span>
                    </label>
                 <div class="password-container">
                    <input type="password" id="login-password" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter your password">
                     <span class="toggle-password" data-target="login-password"><i class="fas fa-eye"></i></span>
                 </div>
            </div>
            <button id="login-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">
                 <span class="english-text">Login</span>
                </button>
            <p class="text-center mt-4 text-sm">
                <span class="english-text">Don't have an account?</span>
                <button id="show-register" class="text-blue-600 hover:underline focus:outline-none dark:text-blue-400">
                     <span class="english-text">Create Account</span>
                    </button>
            </p>
             <p class="text-center mt-2 text-sm">
                <span class="english-text">Forgot password?</span>
                <button id="show-recover" class="text-blue-600 hover:underline focus:outline-none dark:text-blue-400">
                     <span class="english-text">Recover Password</span>
                    </button>
             </p>
        </section>

        <section id="register-section" class="auth-section max-w-sm mx-auto glass-card p-6 hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center">
                <span class="english-text">Create Account</span>
                </h2>
             <div class="mb-4">
                <label for="register-username" class="block text-sm font-medium mb-2">
                    <span class="english-text">Username:</span>
                    </label>
                <input type="text" id="register-username" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Choose a username">
            </div>
            <div class="mb-4">
                <label for="register-password" class="block text-sm font-medium mb-2">
                    <span class="english-text">Password:</span>
                    </label>
                 <div class="password-container">
                    <input type="password" id="register-password" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Create a password">
                     <span class="toggle-password" data-target="register-password"><i class="fas fa-eye"></i></span>
                 </div>
                 <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">
                     <span class="english-text">Min 8 chars, include lowercase, uppercase, numbers, symbols.</span>
                     </p>
            </div>
            <div class="mb-6">
                <label for="register-confirm-password" class="block text-sm font-medium mb-2">
                    <span class="english-text">Confirm Password:</span>
                    </label>
                 <div class="password-container">
                    <input type="password" id="register-confirm-password" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Confirm your password">
                     <span class="toggle-password" data-target="register-confirm-password"><i class="fas fa-eye"></i></span>
                 </div>
            </div>

             <div class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4">
                 <h3 class="text-xl font-medium mb-4 text-center">
                     <span class="english-text">Security Questions (for Recovery)</span>
                     </h3>
                 <div class="mb-4">
                     <label for="security-q1" class="block text-sm font-medium mb-2">
                         <span class="english-text">Question 1:</span>
                         </label>
                     <select id="security-q1" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                         <option value=""><span class="english-text">Select a question</span></option>
                         <option value="What is your mother's maiden name?"><span class="english-text">What is your mother's maiden name?</span></option>
                         <option value="What was the name of your first pet?"><span class="english-text">What was the name of your first pet?</span></option>
                         <option value="What is your favorite book?"><span class="english-text">What is your favorite book?</span></option>
                          <option value="What city were you born in?"><span class="english-text">What city were you born in?</span></option>
                     </select>
                     <label for="security-a1" class="block text-sm font-medium mb-2 mt-2">
                         <span class="english-text">Answer 1:</span>
                         </label>
                     <input type="text" id="security-a1" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter your answer">
                 </div>
                  <div class="mb-4">
                     <label for="security-q2" class="block text-sm font-medium mb-2">
                         <span class="english-text">Question 2:</span>
                         </label>
                     <select id="security-q2" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                         <option value=""><span class="english-text">Select a question</span></option>
                         <option value="What is the name of your elementary school?"><span class="english-text">What is the name of your elementary school?</span></option>
                         <option value="What is your favorite movie?"><span class="english-text">What is your favorite movie?</span></option>
                         <option value="What is the make of your first car?"><span class="english-text">What is the make of your first car?</span></option>
                          <option value="What is your father's middle name?"><span class="english-text">What is your father's middle name?</span></option>
                     </select>
                     <label for="security-a2" class="block text-sm font-medium mb-2 mt-2">
                         <span class="english-text">Answer 2:</span>
                         </label>
                     <input type="text" id="security-a2" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter your answer">
                 </div>
                  <div class="mb-4">
                     <label for="security-q3" class="block text-sm font-medium mb-2">
                         <span class="english-text">Question 3:</span>
                         </label>
                     <select id="security-q3" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                         <option value=""><span class="english-text">Select a question</span></option>
                         <option value="What is the street name you grew up on?"><span class="english-text">What is the street name you grew up on?</span></option>
                         <option value="What is your favorite food?"><span class="english-text">What is your favorite food?</span></option>
                         <option value="What is the name of your favorite teacher?"><span class="english-text">What is the name of your favorite teacher?</span></option>
                          <option value="What is the name of your first school?"><span class="english-text">What is the name of your first school?</span></option>
                     </select>
                     <label for="security-a3" class="block text-sm font-medium mb-2 mt-2">
                         <span class="english-text">Answer 3:</span>
                         </label>
                     <input type="text" id="security-a3" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter your answer">
                 </div>
             </div>


            <button id="register-btn" class="w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 ease-in-out">
                 <span class="english-text">Create Account</span>
                </button>
            <p class="text-center mt-4 text-sm">
                <span class="english-text">Already have an account?</span>
                <button id="show-login" class="text-blue-600 hover:underline focus:outline-none dark:text-blue-400">
                     <span class="english-text">Login</span>
                    </button>
            </p>
        </section>

         <section id="recover-section" class="auth-section max-w-sm mx-auto glass-card p-6 hidden">
             <h2 class="text-2xl font-semibold mb-6 text-center">
                 <span class="english-text">Recover Password</span>
                 </h2>
              <div id="recover-step-1">
                 <p class="mb-4 text-sm text-center">
                     <span class="english-text">Enter your username to find your security questions.</span>
                     </p>
                  <div class="mb-4">
                     <label for="recover-username" class="block text-sm font-medium mb-2">
                         <span class="english-text">Username:</span>
                         </label>
                     <input type="text" id="recover-username" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter your username">
                 </div>
                 <button id="find-account-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">
                     <span class="english-text">Find Account</span>
                     </button>
              </div>

              <div id="recover-step-2" class="hidden">
                  <p class="mb-4 text-sm text-center">
                      <span class="english-text">Answer your security questions.</span>
                      </p>
                   <div class="mb-4">
                      <label id="recover-q1-label" class="block text-sm font-medium mb-2">Question 1:</label> <input type="text" id="recover-a1" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter your answer">
                   </div>
                    <div class="mb-4">
                      <label id="recover-q2-label" class="block text-sm font-medium mb-2">Question 2:</label> <input type="text" id="recover-a2" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter your answer">
                   </div>
                    <div class="mb-4">
                      <label id="recover-q3-label" class="block text-sm font-medium mb-2">Question 3:</label> <input type="text" id="recover-a3" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter your answer">
                   </div>
                   <button id="verify-answers-btn" class="w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 ease-in-out">
                       <span class="english-text">Verify Answers</span>
                       </button>
              </div>

               <div id="recover-step-3" class="hidden">
                  <p class="mb-4 text-sm text-center">
                      <span class="english-text">Set your new password.</span>
                      </p>
                   <div class="mb-4">
                       <label for="recover-new-password" class="block text-sm font-medium mb-2">
                           <span class="english-text">New Password:</span>
                           </label>
                        <div class="password-container">
                           <input type="password" id="recover-new-password" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Create a new password">
                            <span class="toggle-password" data-target="recover-new-password"><i class="fas fa-eye"></i></span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">
                            <span class="english-text">Min 8 chars, include lowercase, uppercase, numbers, symbols.</span>
                            </p>
                   </div>
                    <div class="mb-6">
                       <label for="recover-confirm-new-password" class="block text-sm font-medium mb-2">
                           <span class="english-text">Confirm New Password:</span>
                           </label>
                        <div class="password-container">
                           <input type="password" id="recover-confirm-new-password" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Confirm your new password">
                            <span class="toggle-password" data-target="recover-confirm-new-password"><i class="fas fa-eye"></i></span>
                        </div>
                   </div>
                   <button id="set-new-password-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">
                       <span class="english-text">Set Password</span>
                       </button>
              </div>


             <p class="text-center mt-4 text-sm">
                 <span class="english-text">Back to</span>
                 <button id="show-login-from-recover" class="text-blue-600 hover:underline focus:outline-none dark:text-blue-400">
                     <span class="english-text">Login</span>
                     </button>
                 <span class="english-text">page.</span>
                 </p>
         </section>

    </div>


    <div id="main-app-container" class="hidden flex-grow flex flex-col">
         <nav class="flex items-center justify-between space-x-4 mb-8">
            <div class="flex space-x-4">
                <button class="nav-button px-4 py-2 rounded-md transition duration-300 ease-in-out hover:bg-blue-500 hover:text-white" data-target="dashboard-section">Dashboard</button>
                <button class="nav-button px-4 py-2 rounded-md transition duration-300 ease-in-out hover:bg-blue-500 hover:text-white" data-target="add-entry-section">Add Entry</button>
                <button class="nav-button px-4 py-2 rounded-md transition duration-300 ease-in-out hover:bg-blue-500 hover:text-white" data-target="reports-section">Reports</button>
                <button class="nav-button px-4 py-2 rounded-md transition duration-300 ease-in-out hover:bg-blue-500 hover:text-white" data-target="settings-section">Settings</button>
                 <button class="nav-button px-4 py-2 rounded-md transition duration-300 ease-in-out hover:bg-blue-500 hover:text-white" data-target="profile-section">
                     <span class="english-text">Profile</span>
                     </button>
            </div>

            <div class="flex items-center gap-2">
                <span id="logged-in-user" class="text-sm font-medium mr-4"></span> <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300 ease-in-out"> <span class="english-text">Logout</span>
                     </button>
                <span class="text-sm font-medium">Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </nav>

        <section id="dashboard-section" class="app-section">
            <h2 class="text-2xl font-semibold mb-6 text-center">Dashboard</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass-card p-6 text-center">
                    <h3 class="text-xl font-medium">Total Income</h3>
                    <p id="total-income" class="text-3xl font-bold text-green-600 mt-2 dark:text-green-400">0</p>
                </div>
                <div class="glass-card p-6 text-center">
                    <h3 class="text-xl font-medium">Total Expense</h3>
                    <p id="total-expense" class="text-3xl font-bold text-red-600 mt-2 dark:text-red-400">0</p>
                </div>
                <div class="glass-card p-6 text-center">
                    <h3 class="text-xl font-medium">Savings</h3>
                    <p id="total-savings" class="text-3xl font-bold text-blue-600 mt-2 dark:text-blue-400">0</p>
                </div>
            </div>

            <div class="sticky-header rounded-md mb-6 p-4">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                         <label for="view-selector" class="font-medium">View:</label>
                         <select id="view-selector" class="p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600 w-auto">
                             <option value="all">All</option> <option value="daily">Daily</option>
                             <option value="weekly">Weekly</option>
                             <option value="monthly">Monthly</option>
                             <option value="yearly">Yearly</option>
                             <option value="custom">Custom</option>
                         </select>
                    </div>
                    <div id="custom-date-range" class="flex items-center gap-4 hidden">
                        <label for="start-date" class="font-medium">From:</label>
                        <input type="date" id="start-date" class="p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                        <label for="end-date" class="font-medium">To:</label>
                        <input type="date" id="end-date" class="p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                         <button id="apply-date-filter" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">Apply</button>
                    </div>
                </div>
            </div>


            <div class="grid grid-cols-1 gap-6">
                <div class="glass-card p-6">
                    <h3 class="text-xl font-medium mb-4 text-center">Income vs Expense</h3>
                    <div class="chart-container">
                        <canvas id="incomeExpenseChart"></canvas>
                    </div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-xl font-medium mb-4 text-center">Category Breakdown (Expense)</h3>
                     <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                     </div>
                </div>
            </div>
        </section>

        <section id="add-entry-section" class="app-section hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center">Add New Entry</h2>
            <div class="glass-card p-6 max-w-md mx-auto">
                <div class="mb-4">
                    <label for="entry-type" class="block text-sm font-medium mb-2">Type:</label>
                    <select id="entry-type" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="entry-amount" class="block text-sm font-medium mb-2">Amount:</label>
                    <input type="number" id="entry-amount" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter amount" min="0" step="0.01">
                </div>
                 <div class="mb-4">
                    <label for="entry-category" class="block text-sm font-medium mb-2">Category:</label>
                    <select id="entry-category" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                        </select>
                </div>
                <div class="mb-4">
                    <label for="entry-date" class="block text-sm font-medium mb-2">Date:</label>
                    <input type="date" id="entry-date" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div class="mb-6">
                    <label for="entry-notes" class="block text-sm font-medium mb-2">Notes (Optional):</label>
                    <textarea id="entry-notes" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" rows="3" placeholder="Add notes"></textarea>
                </div>
                <button id="save-entry" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">Save Entry</button>
            </div>
        </section>

        <section id="reports-section" class="app-section hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center">Reports</h2>

            <div class="sticky-header rounded-md mb-6 p-4">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                         <label for="report-view-selector" class="font-medium">View:</label>
                         <select id="report-view-selector" class="p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                             <option value="daily">Daily</option>
                             <option value="weekly">Weekly</option>
                             <option value="monthly">Monthly</option>
                             <option value="yearly">Yearly</option>
                             <option value="custom">Custom</option>
                             <option value="all">All</option>
                         </select>
                    </div>
                    <div id="report-custom-date-range" class="flex items-center gap-4 hidden">
                        <label for="report-start-date" class="font-medium">From:</label>
                        <input type="date" id="report-start-date" class="p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                        <label for="report-end-date" class="font-medium">To:</label>
                        <input type="date" id="report-end-date" class="p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                         <button id="apply-report-filter" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">Apply</button>
                    </div>
                     <button id="export-report-pdf" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 ease-in-out">Export to PDF</button>
                </div>
            </div>

            <div class="flex justify-end mb-4">
                 <button id="add-new-entry-report" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">Add New Entry</button>
             </div>

            <div class="glass-card p-6 overflow-x-auto mb-6"> <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Notes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                        </tbody>
                </table>
            </div>

            <div class="glass-card p-6">
                 <h3 class="text-xl font-medium mb-4 text-center">Summary for Selected Period</h3>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                     <div>
                         <p class="text-lg font-medium">Total Income:</p>
                         <p id="report-total-income" class="text-2xl font-bold text-green-600 dark:text-green-400">0.00</p>
                     </div>
                     <div>
                         <p class="text-lg font-medium">Total Expense:</p>
                         <p id="report-total-expense" class="text-2xl font-bold text-red-600 dark:text-red-400">0.00</p>
                     </div>
                     <div>
                         <p class="text-lg font-medium">Balance:</p>
                         <p id="report-balance" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0.00</p>
                     </div>
                 </div>
            </div>

        </section>

        <section id="profile-section" class="app-section hidden">
             <h2 class="text-2xl font-semibold mb-6 text-center">
                 <span class="english-text">Profile</span>
                 </h2>
             <div class="glass-card p-6 max-w-md mx-auto">
                 <div class="mb-6">
                     <h3 class="text-xl font-medium mb-4">
                         <span class="english-text">Account Information</span>
                         </h3>
                     <div class="mb-4">
                         <label class="block text-sm font-medium mb-2">
                             <span class="english-text">Username:</span>
                             </label>
                         <p id="profile-username" class="p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600 bg-gray-100 dark:bg-gray-800"></p>
                     </div>
                     </div>

                 <div class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4">
                     <h3 class="text-xl font-medium mb-4">
                         <span class="english-text">Change Password</span>
                         </h3>
                      <div class="mb-4">
                         <label for="current-password" class="block text-sm font-medium mb-2">
                             <span class="english-text">Current Password:</span>
                             </label>
                          <div class="password-container">
                             <input type="password" id="current-password" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter current password">
                              <span class="toggle-password" data-target="current-password"><i class="fas fa-eye"></i></span>
                          </div>
                     </div>
                      <div class="mb-4">
                         <label for="new-password" class="block text-sm font-medium mb-2">
                             <span class="english-text">New Password:</span>
                             </label>
                          <div class="password-container">
                             <input type="password" id="new-password" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Enter new password">
                              <span class="toggle-password" data-target="new-password"><i class="fas fa-eye"></i></span>
                          </div>
                         <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">
                             <span class="english-text">Min 8 chars, include lowercase, uppercase, numbers, symbols.</span>
                             </p>
                     </div>
                      <div class="mb-6">
                         <label for="confirm-new-password" class="block text-sm font-medium mb-2">
                             <span class="english-text">Confirm New Password:</span>
                             </label>
                          <div class="password-container">
                             <input type="password" id="confirm-new-password" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600" placeholder="Confirm new password">
                              <span class="toggle-password" data-target="confirm-new-password"><i class="fas fa-eye"></i></span>
                          </div>
                     </div>
                     <button id="change-password-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">
                         <span class="english-text">Change Password</span>
                         </button>
                 </div>
             </div>
         </section>


        <section id="settings-section" class="app-section hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center">Settings</h2>
            <div class="glass-card p-6 max-w-md mx-auto">
                <div class="mb-4">
                    <button id="reset-data" class="w-full px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300 ease-in-out">Reset All Data</button>
                </div>

                <div class="mb-6 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h3 class="text-xl font-medium mb-4">Export Data</h3>

                    <div class="mb-4">
                         <label for="export-view-selector" class="block text-sm font-medium mb-2">Select Data Range:</label>
                         <select id="export-view-selector" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                             <option value="all">All Data</option>
                             <option value="daily">Today</option>
                             <option value="weekly">This Week</option>
                             <option value="monthly">This Month</option>
                             <option value="yearly">This Year</option>
                             <option value="custom">Custom Range</option>
                         </select>
                     </div>
                     <div id="export-custom-date-range" class="flex items-center gap-4 mb-4 hidden">
                         <label for="export-start-date" class="font-medium text-sm">From:</label>
                         <input type="date" id="export-start-date" class="p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm">
                         <label for="export-end-date" class="font-medium text-sm">To:</label>
                         <input type="date" id="export-end-date" class="p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm">
                          </div>


                     <div class="mb-4">
                        <button id="export-json" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">Export Data (JSON)</button>
                    </div>
                    <div class="mb-4">
                         <button id="export-all-pdf" class="w-full px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300 ease-in-out">Export Data (PDF)</button>
                     </div>
                    <div class="mb-4">
                        <button id="export-excel" class="w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 ease-in-out">Export Data (Excel .xlsx)</button>
                    </div>
                     <div>
                        <button id="export-csv" class="w-full px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition duration-300 ease-in-out">Export Data (CSV .csv)</button>
                    </div>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                     <h3 class="text-xl font-medium mb-4">Import Data</h3>
                     <div class="mb-4">
                         <label for="import-json-file" class="block text-sm font-medium mb-2">Import Data (JSON):</label>
                         <input type="file" id="import-json-file" accept=".json" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                         <button id="import-json" class="w-full mt-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">Import JSON</button>
                     </div>
                     <div class="mb-4">
                          <label for="import-excel-csv-file" class="block text-sm font-medium mb-2">Import Data (Excel .xlsx or CSV .csv):</label>
                          <input type="file" id="import-excel-csv-file" accept=".xlsx,.csv" class="w-full p-2 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                          <button id="import-excel-csv" class="w-full mt-2 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-300 ease-in-out">Import File</button>
                     </div>
                </div>
            </div>
        </section>
    </div>

    <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-md shadow-lg hidden">
         <p id="message-text"></p>
     </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // --- Global Variables ---
        let budgetData = []; // Array to store all income/expense entries for the current user
        let incomeExpenseChartInstance = null; // Chart.js instance for Income vs Expense
        let categoryChartInstance = null; // Chart.js instance for Category Breakdown
        let currentUser = null; // Stores the currently logged-in user's identifier (username)
        let recoveryUser = null; // Stores the user object during the recovery process

        // Default categories
        const defaultCategories = {
            income: ['Salary', 'Freelance', 'Gift', 'Other Income'],
            expense: ['Food', 'Transport', 'Utilities', 'Rent', 'Shopping', 'Entertainment', 'Other Expense']
        };

        // Removed Language Storage Key: // const languageStorageKey = 'budgetTrackerLanguage'; // Key for storing language preference


        // --- DOM Elements ---
        // Auth Elements
        const authContainerEl = document.getElementById('auth-container');
        const loginSectionEl = document.getElementById('login-section');
        const registerSectionEl = document.getElementById('register-section');
        const recoverSectionEl = document.getElementById('recover-section'); // Recovery section
        const loginUsernameEl = document.getElementById('login-username'); // Changed to username
        const loginPasswordEl = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const showRegisterBtn = document.getElementById('show-register');
        const showRecoverBtn = document.getElementById('show-recover'); // Show recovery button

        const registerUsernameEl = document.getElementById('register-username');
        // const registerEmailEl = document.getElementById('register-email'); // REMOVED: Element does not exist in HTML
        const registerPasswordEl = document.getElementById('register-password');
        const registerConfirmPasswordEl = document.getElementById('register-confirm-password');
        const registerBtn = document.getElementById('register-btn');
        const showLoginBtn = document.getElementById('show-login');

        // Security Questions elements
        const securityQ1El = document.getElementById('security-q1');
        const securityA1El = document.getElementById('security-a1');
        const securityQ2El = document.getElementById('security-q2');
        const securityA2El = document.getElementById('security-a2');
        const securityQ3El = document.getElementById('security-q3');
        const securityA3El = document.getElementById('security-a3');

        // Recovery elements
        const recoverStep1El = document.getElementById('recover-step-1');
        const recoverStep2El = document.getElementById('recover-step-2');
        const recoverStep3El = document.getElementById('recover-step-3');
        const recoverUsernameEl = document.getElementById('recover-username');
        const findAccountBtn = document.getElementById('find-account-btn');
        const recoverQ1Label = document.getElementById('recover-q1-label');
        const recoverA1El = document.getElementById('recover-a1');
        const recoverQ2Label = document.getElementById('recover-q2-label');
        const recoverA2El = document.getElementById('recover-a2');
        const recoverQ3Label = document.getElementById('recover-q3-label');
        const recoverA3El = document.getElementById('recover-a3');
        const verifyAnswersBtn = document.getElementById('verify-answers-btn');
        const recoverNewPasswordEl = document.getElementById('recover-new-password');
        const recoverConfirmNewPasswordEl = document.getElementById('recover-confirm-new-password');
        const setNewPasswordBtn = document.getElementById('set-new-password-btn');
        const showLoginFromRecoverBtn = document.getElementById('show-login-from-recover');


        // Main App Elements
        const mainAppContainerEl = document.getElementById('main-app-container');
        const navButtons = document.querySelectorAll('.nav-button'); // Select all nav buttons
        const appSections = document.querySelectorAll('.app-section'); // Select all app sections
        const loggedInUserEl = document.getElementById('logged-in-user');
        const logoutBtn = document.getElementById('logout-btn');


        // Dashboard elements
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const totalSavingsEl = document.getElementById('total-savings');
        const viewSelectorEl = document.getElementById('view-selector');
        const customDateRangeEl = document.getElementById('custom-date-range');
        const startDateEl = document.getElementById('start-date');
        const endDateEl = document.getElementById('end-date');
        const applyDateFilterBtn = document.getElementById('apply-date-filter');
        const incomeExpenseChartCanvas = document.getElementById('incomeExpenseChart');
        const categoryChartCanvas = document.getElementById('categoryChart');

        // Add Entry elements (These are now ONLY for adding new entries)
        const addEntrySectionTitle = document.querySelector('#add-entry-section h2');
        const entryTypeEl = document.getElementById('entry-type');
        const entryAmountEl = document.getElementById('entry-amount');
        const entryCategoryEl = document.getElementById('entry-category');
        const entryDateEl = document.getElementById('entry-date');
        const entryNotesEl = document.getElementById('entry-notes');
        const saveEntryBtn = document.getElementById('save-entry');

        // Reports elements
        const reportViewSelectorEl = document.getElementById('report-view-selector');
        const reportCustomDateRangeEl = document.getElementById('report-custom-date-range');
        const reportStartDateEl = document.getElementById('report-start-date');
        const reportEndDateEl = document.getElementById('report-end-date');
        const applyReportFilterBtn = document.getElementById('apply-report-filter');
        const reportTableBodyEl = document.getElementById('report-table-body');
        const exportReportPdfBtn = document.getElementById('export-report-pdf');
        const addNewEntryReportBtn = document.getElementById('add-new-entry-report');

        // Reports Summary Elements
        const reportTotalIncomeEl = document.getElementById('report-total-income');
        const reportTotalExpenseEl = document.getElementById('report-total-expense');
        const reportBalanceEl = document.getElementById('report-balance');

        // Profile elements (NEW)
        const profileSectionEl = document.getElementById('profile-section');
        const profileUsernameEl = document.getElementById('profile-username');
        const currentPasswordEl = document.getElementById('current-password');
        const newPasswordEl = document.getElementById('new-password');
        const confirmNewPasswordEl = document.getElementById('confirm-new-password');
        const changePasswordBtn = document.getElementById('change-password-btn');


        // Settings elements
        const darkModeToggleEl = document.getElementById('dark-mode-toggle');
        const resetDataBtn = document.getElementById('reset-data');
        const exportJsonBtn = document.getElementById('export-json');
        const exportAllPdfBtn = document.getElementById('export-all-pdf');
        const exportExcelBtn = document.getElementById('export-excel');
        const exportCsvBtn = document.getElementById('export-csv');
        const importJsonFileEl = document.getElementById('import-json-file');
        const importJsonBtn = document.getElementById('import-json');
        const importExcelCsvFileEl = document.getElementById('import-excel-csv-file');
        const importExcelCsvBtn = document.getElementById('import-excel-csv');

        // Settings Export Filter elements
        const exportViewSelectorEl = document.getElementById('export-view-selector');
        const exportCustomDateRangeEl = document.getElementById('export-custom-date-range');
        const exportStartDateEl = document.getElementById('export-start-date');
        const exportEndDateEl = document.getElementById('export-end-date');

        // Removed Language Switcher Elements:
        // const languageSelectEl = document.getElementById('language-select');
        // const urduTextElements = document.querySelectorAll('.urdu-text');
        // const englishTextElements = document.querySelectorAll('.english-text');


        // Message box elements
        const messageBoxEl = document.getElementById('message-box');
        const messageTextEl = document.getElementById('message-text');


        // --- Local Storage Keys ---
        const usersStorageKey = 'budgetTrackerUsers'; // Key for storing user accounts
        const dataStoragePrefix = 'budgetTrackerData_'; // Prefix for user-specific data
        // Removed Language Storage Key: // const languageStorageKey = 'budgetTrackerLanguage'; // Key for storing language preference


        // --- Authentication Functions ---

        /**
         * Gets all registered users from localStorage.
         * @returns {Array} - Array of registered user objects.
         */
        function getUsers() {
            try { // Added try-catch
                const users = localStorage.getItem(usersStorageKey);
                return users ? JSON.parse(users) : [];
            } catch (error) {
                console.error("Error getting users from localStorage:", error);
                return []; // Return empty array on error
            }
        }

        /**
         * Saves the list of registered users to localStorage.
         * @param {Array} users - Array of user objects to save.
         */
        function saveUsers(users) {
            try { // Added try-catch
                localStorage.setItem(usersStorageKey, JSON.stringify(users));
            } catch (error) {
                console.error("Error saving users to localStorage:", error);
                showMessage('Error saving account data. Please try again.', 'red'); // Inform user
            }
        }

         /**
          * Generates a random salt.
          * @returns {string} - A random salt string.
          */
         function generateSalt() {
             return CryptoJS.lib.WordArray.random(128/8).toString();
         }

         /**
          * Hashes a password using PBKDF2 with a salt (client-side simulation).
          * NOTE: For a real-world app, hashing should happen on the server.
          * PBKDF2 is better than simple SHA256 for password hashing as it's slower and uses salt.
          * @param {string} password - The password to hash.
          * @param {string} salt - The salt to use.
          * @returns {string} - The hashed password string.
          */
         function hashPassword(password, salt) {
             const hashedPassword = CryptoJS.PBKDF2(password, salt, {
                 keySize: 512/32, // 512 bits
                 iterations: 1000 // Number of iterations (can be increased for more security)
             });
             return hashedPassword.toString();
         }

        /**
         * Validates password strength.
         * @param {string} password - The password to validate.
         * @returns {boolean} - True if password meets criteria, false otherwise.
         */
        function isPasswordStrong(password) {
            if (password.length < 8) {
                return false; // Minimum length
            }
            // Check for at least one lowercase letter, one uppercase letter, one number, one symbol
            const hasLowercase = /[a-z]/.test(password);
            const hasUppercase = /[A-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password); // Common symbols
            return hasLowercase && hasUppercase && hasNumber && hasSymbol;
        }


        /**
         * Registers a new user.
         */
        function registerUser() {
            console.log("Register button clicked. Starting registration process."); // Added log

            const username = registerUsernameEl.value.trim();
            const password = registerPasswordEl.value;
            const confirmPassword = registerConfirmPasswordEl.value;

            // Security Questions and Answers
            const q1 = securityQ1El.value;
            const a1 = securityA1El.value.trim();
            const q2 = securityQ2El.value;
            const a2 = securityA2El.value.trim();
            const q3 = securityQ3El.value;
            const a3 = securityA3El.value.trim();

            console.log("Form values:", { username, password, confirmPassword, q1, a1, q2, a2, q3, a3 }); // Updated log


            if (!username || !password || !confirmPassword || !q1 || !a1 || !q2 || !a2 || !q3 || !a3) {
                showMessage('missingSecurityQuestions', 'red'); // Using message key
                console.log("Validation failed: Missing fields."); // Added log
                return;
            }

            // Validate username (alphanumeric)
            const usernameRegex = /^[a-zA-Z0-9!@#$%^&*()_+\-=\.\/]+$/; // Updated regex
            if (!usernameRegex.test(username)) {
                 showMessage('usernameInvalidFormat', 'red'); // Using message key
                 console.log("Validation failed: Invalid username format."); // Added log
                 return;
            }


            if (password !== confirmPassword) {
                showMessage('passwordsMismatch', 'red'); // Using message key
                console.log("Validation failed: Passwords do not match."); // Added log
                return;
            }

            // Validate password strength
            if (!isPasswordStrong(password)) {
                 showMessage('passwordWeak', 'red'); // Using message key
                 console.log("Validation failed: Password not strong enough."); // Added log
                 return;
            }

            console.log("Basic validations passed."); // Added log


            const users = getUsers();
            console.log("Existing users:", users); // Added log


            // Check if username already exists (case-insensitive check)
            if (users.some(user => user.username.toLowerCase() === username.toLowerCase())) {
                showMessage('usernameTaken', 'red'); // Using message key
                console.log("Validation failed: Username already exists."); // Added log
                return;
            }

             // Check if any two security questions are the same
             if (q1 === q2 || q1 === q3 || q2 === q3) {
                 showMessage('duplicateSecurityQuestions', 'red'); // Using message key
                 console.log("Validation failed: Duplicate security questions."); // Added log
                 return;
             }

            console.log("Username and security questions checks passed."); // Added log


            try { // Added try-catch block
                const salt = generateSalt();
                const hashedPassword = hashPassword(password, salt);

                 // Hash security answers too (optional but good practice)
                 const hashedA1 = hashPassword(a1, salt); // Use the same salt
                 const hashedA2 = hashPassword(a2, salt);
                 const hashedA3 = hashPassword(a3, salt);

                console.log("Password and answers hashed."); // Added log


                const newUser = {
                    username: username,
                    password: hashedPassword,
                    salt: salt, // Store the salt
                     securityQuestions: [
                         { q: q1, a: hashedA1 },
                         { q: q2, a: hashedA2 },
                         { q: q3, a: hashedA3 }
                     ]
                };

                console.log("New user object created:", newUser); // Added log


                users.push(newUser);
                console.log("New user added to users array:", users); // Added log


                saveUsers(users);
                console.log("Users array saved to localStorage."); // Added log


                showMessage('accountCreatedSuccess', 'green'); // Using message key
                // Clear registration form
                registerUsernameEl.value = '';
                registerPasswordEl.value = '';
                registerConfirmPasswordEl.value = '';
                 securityQ1El.value = '';
                 securityA1El.value = '';
                 securityQ2El.value = '';
                 securityA2El.value = '';
                 securityQ3El.value = '';
                 securityA3El.value = '';

                // Switch to login view
                showAuthSection('login-section');
                console.log("Registration successful. Switched to login section."); // Added log


            } catch (error) { // Catch any errors during hashing or saving
                console.error("Error during registration:", error); // Log the error
                showMessage('An error occurred during registration. Please try again.', 'red'); // Generic error message
            }
        }

        /**
         * Logs in an existing user.
         */
        function loginUser() {
            const username = loginUsernameEl.value.trim().toLowerCase(); // Use lowercase for comparison
            const password = loginPasswordEl.value;

            if (!username || !password) {
                showMessage('Please enter your username and password.', 'red'); // Generic message
                return;
            }

            const users = getUsers();
            // Find user by username (case-insensitive)
            const user = users.find(user => user.username.toLowerCase() === username);

            if (user) {
                // Compare hashed password using the stored salt
                const enteredPasswordHash = hashPassword(password, user.salt);
                if (enteredPasswordHash === user.password) {
                    currentUser = user.username; // Set current user identifier to username
                    sessionStorage.setItem('currentUser', currentUser); // Store logged-in user in sessionStorage
                    showMessage(`Welcome, ${user.username}!`, 'green'); // Welcome message with username
                    // Clear login form
                    loginUsernameEl.value = '';
                    loginPasswordEl.value = '';
                    // Show main app
                    showMainApp();
                } else {
                    showMessage('loginFailed', 'red'); // Using message key
                }
            } else {
                showMessage('userNotFound', 'red'); // Using message key
            }
        }

        /**
         * Logs out the current user.
         */
        function logoutUser() {
            currentUser = null; // Clear current user
            sessionStorage.removeItem('currentUser'); // Remove user from sessionStorage
            budgetData = []; // Clear budget data from memory
            // Note: User's data remains in localStorage, linked by username.
            // It's reloaded when they log back in.

            showMessage('Logged out successfully.', 'blue'); // Generic message
            // Show auth view
            showAuthSection('login-section');
             // Clear the logged-in user display
            loggedInUserEl.textContent = '';
             // Destroy chart instances to prevent errors when trying to update
             if (incomeExpenseChartInstance) incomeExpenseChartInstance.destroy();
             if (categoryChartInstance) categoryChartInstance.destroy();
        }

        // --- Password Recovery Functions ---

        /**
         * Initiates the password recovery process by finding the user.
         */
        function findAccountForRecovery() {
            const username = recoverUsernameEl.value.trim().toLowerCase(); // Use lowercase for comparison

            if (!username) {
                showMessage('Please enter your username.', 'red'); // Generic message
                return;
            }

            const users = getUsers();
            // Find user by username (case-insensitive)
            const user = users.find(user => user.username.toLowerCase() === username);

            if (user) {
                 recoveryUser = user; // Store user object for recovery steps
                 // Display security questions (using English as stored)
                 recoverQ1Label.textContent = `Question 1: ${user.securityQuestions[0].q}`; // Simplified label
                 recoverQ2Label.textContent = `Question 2: ${user.securityQuestions[1].q}`; // Simplified label
                 recoverQ3Label.textContent = `Question 3: ${user.securityQuestions[2].q}`; // Simplified label

                 // Clear previous answers
                 recoverA1El.value = '';
                 recoverA2El.value = '';
                 recoverA3El.value = '';

                 // Move to step 2
                 recoverStep1El.classList.add('hidden');
                 recoverStep2El.classList.remove('hidden');
                 recoverStep3El.classList.add('hidden');

            } else {
                showMessage('recoveryFindAccountFailed', 'red'); // Using message key
                 recoverUsernameEl.value = ''; // Clear username input
            }
        }

        /**
         * Verifies the security answers provided by the user.
         */
        function verifySecurityAnswers() {
            if (!recoveryUser) {
                 showMessage('recoveryProcessNotInitiated', 'red'); // Using message key
                 showAuthSection('recover-section'); // Go back to step 1
                 return;
            }

            const a1 = recoverA1El.value.trim();
            const a2 = recoverA2El.value.trim();
            const a3 = recoverA3El.value.trim();

             if (!a1 || !a2 || !a3) {
                 showMessage('answerSecurityQuestions', 'red'); // Using message key
                 return;
             }

             // Hash the provided answers using the user's salt and compare
             const hashedA1 = hashPassword(a1, recoveryUser.salt);
             const hashedA2 = hashPassword(a2, recoveryUser.salt);
             const hashedA3 = hashPassword(a3, recoveryUser.salt);

             if (hashedA1 === recoveryUser.securityQuestions[0].a &&
                 hashedA2 === recoveryUser.securityQuestions[1].a &&
                 hashedA3 === recoveryUser.securityQuestions[2].a) {

                 showMessage('recoveryAnswersVerified', 'green'); // Using message key
                 // Move to step 3
                 recoverStep1El.classList.add('hidden');
                 recoverStep2El.classList.add('hidden');
                 recoverStep3El.classList.remove('hidden');

                 // Clear password fields
                 recoverNewPasswordEl.value = '';
                 recoverConfirmNewPasswordEl.value = '';

             } else {
                 showMessage('recoveryAnswersIncorrect', 'red'); // Using message key
                 // Optionally clear answers or let them retry
             }
        }

        /**
         * Sets the new password for the recovered account.
         */
        function setNewPassword() {
            if (!recoveryUser) {
                 showMessage('recoveryProcessNotInitiated', 'red'); // Using message key
                 showAuthSection('recover-section'); // Go back to step 1
                 return;
            }

            const newPassword = recoverNewPasswordEl.value;
            const confirmNewPassword = recoverConfirmNewPasswordEl.value;

            if (!newPassword || !confirmNewPassword) {
                showMessage('Please enter and confirm your new password.', 'red'); // Generic message
                return;
            }

             if (newPassword !== confirmNewPassword) {
                 showMessage('New passwords do not match.', 'red'); // Generic message
                 return;
             }

             // Validate new password strength
             if (!isPasswordStrong(newPassword)) {
                  showMessage('New password must be at least 8 characters long and include lowercase, uppercase, numbers, and symbols.', 'red'); // Generic message
                  return;
             }

            const users = getUsers();
            const userIndex = users.findIndex(user => user.username === recoveryUser.username);

            if (userIndex !== -1) {
                 // Generate a new salt for the new password (good practice)
                 const newSalt = generateSalt();
                 const newHashedPassword = hashPassword(newPassword, newSalt);

                 users[userIndex].password = newHashedPassword;
                 users[userIndex].salt = newSalt; // Update the salt

                 saveUsers(users);

                 showMessage('passwordResetSuccess', 'green'); // Using message key

                 // Clear recovery user state
                 recoveryUser = null;
                 // Switch to login view
                 showAuthSection('login-section');

            } else {
                 showMessage('Error: User not found during password reset.', 'red'); // Generic message
                 recoveryUser = null; // Clear state
                 showAuthSection('login-section'); // Go back to login
            }
        }


        /**
         * Shows the authentication container and hides the main app.
         * @param {string} sectionId - The ID of the auth section to show ('login-section', 'register-section', or 'recover-section').
         */
        function showAuthSection(sectionId) {
             mainAppContainerEl.classList.add('hidden');
             authContainerEl.classList.remove('hidden');

             loginSectionEl.classList.add('hidden');
             registerSectionEl.classList.add('hidden');
             recoverSectionEl.classList.add('hidden'); // Hide recovery section by default

             if (sectionId === 'login-section') {
                 loginSectionEl.classList.remove('hidden');
             } else if (sectionId === 'register-section') {
                 registerSectionEl.classList.remove('hidden');
             } else if (sectionId === 'recover-section') {
                 recoverSectionEl.classList.remove('hidden');
                 // Reset recovery steps when showing recovery section
                 recoverStep1El.classList.remove('hidden');
                 recoverStep2El.classList.add('hidden');
                 recoverStep3El.classList.add('hidden');
                 recoverUsernameEl.value = ''; // Clear username input
                 recoveryUser = null; // Clear any previous recovery state
                 // Clear security answer inputs
                 recoverA1El.value = '';
                 recoverA2El.value = '';
                 recoverA3El.value = '';
             }
        }

        /**
         * Shows the main app container and hides the auth sections.
         */
        function showMainApp() {
             authContainerEl.classList.add('hidden');
             mainAppContainerEl.classList.remove('hidden');
             // Load user-specific data and update UI after login
             loadData();
             updateDashboard();
             updateReportTable();
             // Show the logged-in username
             const users = getUsers();
             const user = users.find(user => user.username === currentUser); // Find user by username
             if (user) {
                 loggedInUserEl.textContent = `Logged in as: ${user.username}`;
             }
             // Show dashboard by default after login
             showSection('dashboard-section');

             // Set default date to today's date for Add Entry form after login
             entryDateEl.valueAsDate = new Date();
        }


        // Event listeners for auth buttons
        showRegisterBtn.addEventListener('click', () => showAuthSection('register-section'));
        showLoginBtn.addEventListener('click', () => showAuthSection('login-section'));
        showRecoverBtn.addEventListener('click', () => showAuthSection('recover-section')); // Show recovery section
        showLoginFromRecoverBtn.addEventListener('click', () => showAuthSection('login-section')); // Back to login from recover

        registerBtn.addEventListener('click', registerUser);
        loginBtn.addEventListener('click', loginUser);
        logoutBtn.addEventListener('click', logoutUser);

        // Event listeners for recovery buttons
        findAccountBtn.addEventListener('click', findAccountForRecovery);
        verifyAnswersBtn.addEventListener('click', verifySecurityAnswers);
        setNewPasswordBtn.addEventListener('click', setNewPassword);


        // --- Password Toggle Functionality ---
        /**
         * Toggles the visibility of a password input field.
         * @param {string} targetId - The ID of the password input field.
         */
        function togglePasswordVisibility(targetId) {
            const passwordInput = document.getElementById(targetId);
            const icon = document.querySelector(`.toggle-password[data-target="${targetId}"] i`);

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Add event listeners to all toggle password icons
        document.querySelectorAll('.toggle-password').forEach(icon => {
            icon.addEventListener('click', (event) => {
                const targetId = event.currentTarget.dataset.target;
                togglePasswordVisibility(targetId);
            });
        });


        // Removed Language Switching Functionality ---
        /*
        function setLanguage(lang) {
            document.body.classList.remove('lang-en', 'lang-ur');
            document.body.classList.add(`lang-${lang}`);
            document.documentElement.lang = lang;
            localStorage.setItem(languageStorageKey, lang);
            updatePlaceholders(lang);
             if (document.getElementById('reports-section').classList.contains('hidden') === false) {
                 updateReportTable();
             }
             if (!profileSectionEl.classList.contains('hidden') && currentUser) {
                 profileUsernameEl.textContent = currentUser;
             }
        }
         function updatePlaceholders(lang) {
             const placeholders = {
                 'login-username': { en: 'Enter your username', ur: 'اپنا یوزر نیم درج کریں' },
                 // ... other placeholders ...
             };
             for (const id in placeholders) {
                 const element = document.getElementById(id);
                 if (element) {
                     element.placeholder = placeholders[id][lang];
                 }
             }
              if (recoveryUser) {
                  recoverQ1Label.textContent = `${lang === 'ur' ? 'سوال 1: ' : 'Question 1: '}${recoveryUser.securityQuestions[0].q}`;
                  recoverQ2Label.textContent = `${lang === 'ur' ? 'سوال 2: ' : 'Question 2: '}${recoveryUser.securityQuestions[1].q}`;
                  recoverQ3Label.textContent = `${lang === 'ur' ? 'سوال 3: ' : 'Question 3: '}${recoveryUser.securityQuestions[2].q}`;
              }
         }
        languageSelectEl.addEventListener('change', (event) => {
            setLanguage(event.target.value);
        });
        */

        // --- Local Storage Functions (Updated for User Specific Data) ---
        /**
         * Loads budget data for the current user from localStorage.
         * @returns {Array} - Loaded budget data.
         */
        function loadData() {
            if (!currentUser) {
                 budgetData = []; // Clear data if no user is logged in
                 return budgetData; // Return empty array
            }
            try { // Added try-catch
                const data = localStorage.getItem(dataStoragePrefix + currentUser);
                if (data) {
                    budgetData = JSON.parse(data);
                    // Ensure dates are Date objects for easier comparison and add timestamp if missing
                    budgetData.forEach(entry => {
                        try {
                             entry.date = new Date(entry.date);
                             if (isNaN(entry.date.getTime())) {
                                console.error('Invalid date found for user', currentUser, 'in localStorage:', entry.date);
                             }
                             // Add timestamp if it doesn't exist (for older entries)
                             if (entry.timestamp === undefined) {
                                 entry.timestamp = Date.now() + Math.random(); // Add a unique-ish timestamp
                             }
                        } catch (e) {
                             console.error('Error parsing date for user', currentUser, 'from localStorage:', entry.date, e);
                        }
                    });
                     // Filter out any potentially invalid entries after parsing
                     budgetData = budgetData.filter(entry => entry.date && !isNaN(entry.date.getTime()));

                } else {
                    budgetData = [];
                }
                 console.log(`Loaded ${budgetData.length} entries for user: ${currentUser}`);
                 return budgetData; // Return loaded data
            } catch (error) {
                console.error(`Error loading data for user ${currentUser} from localStorage:`, error);
                showMessage('Error loading your budget data.', 'red'); // Generic message
                budgetData = []; // Clear data in memory on error
                return budgetData; // Return empty array on error
            }
        }

        /**
         * Saves current budget data for the current user to localStorage.
         */
        function saveData() {
            if (!currentUser) {
                 console.warn("Attempted to save data with no user logged in.");
                 return;
            }
            console.log(`Saving data for user: ${currentUser}`);
            try { // Added try-catch
                localStorage.setItem(dataStoragePrefix + currentUser, JSON.stringify(budgetData));
                console.log("Data saved.");
            } catch (error) {
                console.error(`Error saving data for user ${currentUser} to localStorage:`, error);
                showMessage('Error saving your budget data. Please try again.', 'red'); // Generic message
            }
        }

         /**
          * Deletes a budget entry by its timestamp.
          * @param {number} timestamp - The timestamp of the entry to delete.
          */
         function deleteEntry(timestamp) {
              if (!currentUser) {
                  showMessage('Please login to delete entries.', 'red'); // Generic message
                  return;
              }
              console.log("Attempting to delete entry with timestamp:", timestamp); // Debugging log

              const initialLength = budgetData.length;
              budgetData = budgetData.filter(entry => entry.timestamp !== timestamp);
              const newLength = budgetData.length;

              if (newLength < initialLength) {
                  console.log("Entry found and removed from budgetData array."); // Debugging log
                  saveData();
                  showMessage('entryDeletedSuccess', 'green'); // Using message key
                  updateDashboard(); // Update dashboard after deletion
                  updateReportTable(); // Update report table after deletion
              } else {
                   console.warn("Entry with timestamp not found:", timestamp); // Debugging log
                  showMessage('entryNotFound', 'red'); // Using message key
              }
         }


        // --- Navigation (Updated to handle auth state) ---
        /**
         * Shows the selected section and hides others.
         * @param {string} targetId - The ID of the section to show.
         */
        function showSection(targetId) {
            // Ensure main app container is visible before showing sections
            mainAppContainerEl.classList.remove('hidden');
            authContainerEl.classList.add('hidden');


            appSections.forEach(section => {
                if (section.id === targetId) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });

            navButtons.forEach(button => {
                if (button.dataset.target === targetId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // Update content based on the section
            if (targetId === 'dashboard-section') {
                updateDashboard();
            } else if (targetId === 'add-entry-section') {
                 populateCategoryDropdown(entryTypeEl, entryCategoryEl); // Populate category dropdown on Add Entry page
                 resetAddEntryForm(); // Ensure form is clear for new entry
            } else if (targetId === 'reports-section') {
                 updateReportTable(); // Ensure report table is updated when navigating to reports
            } else if (targetId === 'settings-section') {
                 // Set default date inputs for export filter when settings is shown
                 const today = new Date().toISOString().split('T')[0];
                 exportStartDateEl.value = today;
                 exportEndDateEl.value = today;
                 // Ensure custom date range is hidden by default when entering settings
                 exportCustomDateRangeEl.classList.add('hidden');
                 exportViewSelectorEl.value = 'all'; // Default to 'All Data'
            } else if (targetId === 'profile-section') { // Profile section logic
                 if (currentUser) {
                     profileUsernameEl.textContent = currentUser; // Display current username
                     // Clear password fields when showing profile
                     currentPasswordEl.value = '';
                     newPasswordEl.value = '';
                     confirmNewPasswordEl.value = '';
                 } else {
                     // Should not happen if navigation is guarded by currentUser check,
                     // but as a fallback:
                     showMessage('loginRequiredProfile', 'red'); // Using message key
                     showAuthSection('login-section');
                 }
            }
        }

        // Event listeners for navigation buttons
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                 if (currentUser) { // Only allow navigation if logged in
                    showSection(button.dataset.target);
                 } else {
                     showMessage('loginRequired', 'blue'); // Using message key
                 }
            });
        });

        // --- Dashboard Logic (No changes needed, uses filterDataByView) ---
        /**
         * Filters data based on the selected view and date range.
         * @returns {Array} - Filtered budget data.
         */
        function filterDataByView() {
            const view = viewSelectorEl.value;
            const now = new Date();
            let filteredData = [];

            const start = startDateEl.value ? new Date(startDateEl.value) : null;
            const end = endDateEl.value ? new Date(endDateEl.value) : null;

             // Helper function to check if a date is within a range (inclusive)
            const isDateInRange = (date, start, end) => {
                 if (!start && !end) return true; // No filter
                 if (start && !end) return date >= start;
                 if (!start && end) return date <= end;
                 return date >= start && date <= end;
            };

            switch (view) {
                case 'daily':
                    filteredData = budgetData.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === now.getFullYear() &&
                               entryDate.getMonth() === now.getMonth() &&
                               entryDate.getDate() === now.getDate();
                    });
                    break;
                case 'weekly':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);

                    const endOfWeek = new Date(now);
                    endOfWeek.setDate(now.getDate() + (6 - now.getDay()));
                    endOfWeek.setHours(23, 59, 59, 999);

                    filteredData = budgetData.filter(entry => {
                         const entryDate = new Date(entry.date);
                          // Ensure entryDate is a valid Date object before comparison
                         return entryDate instanceof Date && !isNaN(entryDate.getTime()) && entryDate >= startOfWeek && entryDate <= endOfWeek;
                    });
                    break;
                case 'monthly':
                    filteredData = budgetData.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === now.getFullYear() &&
                               entryDate.getMonth() === now.getMonth();
                    });
                    break;
                case 'yearly':
                    filteredData = budgetData.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === now.getFullYear();
                    });
                    break;
                case 'custom':
                     if (start && end) {
                          // Adjust end date to include the whole day
                          const adjustedEnd = new Date(end);
                          adjustedEnd.setHours(23, 59, 59, 999);
                          filteredData = budgetData.filter(entry => {
                               const entryDate = new Date(entry.date);
                               return entryDate >= start && entryDate <= adjustedEnd;
                          });
                     } else {
                         // If custom is selected but dates aren't set, show all
                         filteredData = [...budgetData];
                     }
                    break;
                case 'all': // Handle 'all' case - return all data
                default:
                    filteredData = [...budgetData]; // Show all by default or if view is 'all'
                    break;
            }

            return filteredData;
        }


        /**
         * Updates the dashboard overview cards and charts.
         */
        function updateDashboard() {
             if (!currentUser) return; // Don't update if not logged in

            const filteredData = filterDataByView();

            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {}; // To count expenses per category

            filteredData.forEach(entry => {
                if (entry.type === 'income') {
                    totalIncome += entry.amount;
                } else if (entry.type === 'expense') {
                    totalExpense += entry.amount;
                    // Count expense by category
                    if (expenseCategories[entry.category]) {
                        expenseCategories[entry.category] += entry.amount;
                    } else {
                        expenseCategories[entry.category] = entry.amount;
                    }
                }
            });

            const totalSavings = totalIncome - totalExpense;

            totalIncomeEl.textContent = totalIncome.toFixed(2);
            totalExpenseEl.textContent = totalExpense.toFixed(2);
            totalSavingsEl.textContent = totalSavings.toFixed(2);

            // Update Charts
            updateIncomeExpenseChart(totalIncome, totalExpense);
            updateCategoryChart(expenseCategories);
        }

        /**
         * Updates or creates the Income vs Expense chart.
         * @param {number} income - Total income.
         * @param {number} expense - Total expense.
         */
        function updateIncomeExpenseChart(income, expense) {
             // Only update if canvas element exists (i.e., main app is visible)
             if (!incomeExpenseChartCanvas) return;

             if (incomeExpenseChartInstance) {
                 incomeExpenseChartInstance.destroy(); // Destroy previous instance
             }

             const isDarkMode = document.body.classList.contains('dark');
             const textColor = isDarkMode ? '#e2e8f0' : '#1a202c';
             const gridColor = isDarkMode ? 'rgba(226, 232, 240, 0.1)' : 'rgba(26, 32, 44, 0.1)'; // Light grid in dark mode, dark grid in light mode

             incomeExpenseChartInstance = new Chart(incomeExpenseChartCanvas, {
                 type: 'bar',
                 data: {
                     labels: ['Income', 'Expense'],
                     datasets: [{
                         label: 'Amount',
                         data: [income, expense],
                         backgroundColor: [
                             'rgba(75, 192, 192, 0.8)', // Slightly more opaque for modern feel
                             'rgba(255, 99, 132, 0.8)'
                         ],
                         borderColor: [
                             'rgba(75, 192, 192, 1)',
                             'rgba(255, 99, 132, 1)'
                         ],
                         borderWidth: 1,
                         borderRadius: 5 // Rounded corners for bars
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false, // Allow chart to resize freely
                     plugins: {
                         legend: {
                             labels: {
                                 color: textColor // Dynamic legend color
                             }
                         },
                         tooltip: { // Improved tooltips
                             backgroundColor: isDarkMode ? 'rgba(226, 232, 240, 0.9)' : 'rgba(26, 32, 44, 0.9)',
                             titleColor: isDarkMode ? '#1a202c' : '#f0f4f8',
                             bodyColor: isDarkMode ? '#1a202c' : '#f0f4f8',
                             borderColor: isDarkMode ? '#1a202c' : '#f0f4f8',
                             borderWidth: 1,
                             cornerRadius: 5,
                              callbacks: { // Add percentage to tooltip
                                  label: function(context) {
                                      let label = context.label || '';
                                      if (label) {
                                          label += ': ';
                                      }
                                      if (context.parsed !== null) {
                                          const total = context.dataset.data.reduce((sum, value) => sum + value, 0);
                                          const percentage = ((context.parsed / total) * 100).toFixed(2) + '%';
                                          label += context.parsed.toFixed(2) + ' (' + percentage + ')';
                                      }
                                      return label;
                                  }
                              }
                         }
                     },
                     scales: {
                         y: {
                             beginAtZero: true,
                             ticks: {
                                 color: textColor // Dynamic tick color
                             },
                              grid: {
                                 color: gridColor // Dynamic grid color
                             }
                         },
                         x: {
                             ticks: {
                                 color: textColor // Dynamic tick color
                             },
                              grid: {
                                 color: gridColor // Dynamic grid color
                             }
                         }
                     }
                 }
             });
        }

        /**
         * Updates or creates the Category Breakdown chart (Pie chart for expenses).
         * @param {object} expenseCategories - Object with category names as keys and total amounts as values.
         */
        function updateCategoryChart(expenseCategories) {
             // Only update if canvas element exists (i.e., main app is visible)
             if (!categoryChartCanvas) return;

            if (categoryChartInstance) {
                categoryChartInstance.destroy(); // Destroy previous instance
            }

            const categories = Object.keys(expenseCategories);
            const amounts = Object.values(expenseCategories);

             // Generate dynamic colors for pie chart slices
             const colors = categories.map((_, index) => `hsl(${index * 60}, 70%, 60%)`);

             const isDarkMode = document.body.classList.contains('dark');
             const textColor = isDarkMode ? '#e2e8f0' : '#1a202c';


            categoryChartInstance = new Chart(categoryChartCanvas, {
                type: 'doughnut', // Changed to doughnut for a slightly different look
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Amount',
                        data: amounts,
                        backgroundColor: colors,
                        borderColor: isDarkMode ? '#1a202c' : '#f0f4f8', // Border color matching background
                        borderWidth: 2, // Increased border width for better separation
                         hoverBorderColor: isDarkMode ? '#e2e8f0' : '#1a202c', // Hover effect border
                         hoverBorderWidth: 3 // Increased hover border width
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow chart to resize freely
                     plugins: {
                         legend: {
                             labels: {
                                 color: textColor // Dynamic legend color
                             }
                         },
                         tooltip: { // Improved tooltips
                             backgroundColor: isDarkMode ? 'rgba(226, 232, 240, 0.9)' : 'rgba(26, 32, 44, 0.9)',
                             titleColor: isDarkMode ? '#1a202c' : '#f0f4f8',
                             bodyColor: isDarkMode ? '#1a202c' : '#f0f4f8',
                             borderColor: isDarkMode ? '#1a202c' : '#f0f4f8',
                             borderWidth: 1,
                             cornerRadius: 5,
                              callbacks: { // Add percentage to tooltip
                                  label: function(context) {
                                      let label = context.label || '';
                                      if (label) {
                                          label += ': ';
                                      }
                                      if (context.parsed !== null) {
                                          const total = context.dataset.data.reduce((sum, value) => sum + value, 0);
                                          const percentage = ((context.parsed / total) * 100).toFixed(2) + '%';
                                          label += context.parsed.toFixed(2) + ' (' + percentage + ')';
                                      }
                                      return label;
                                  }
                              }
                         }
                     }
                }
            });
        }


        // Event listener for view selector change
        viewSelectorEl.addEventListener('change', (event) => {
             if (!currentUser) return; // Only filter if logged in
            if (event.target.value === 'custom') {
                customDateRangeEl.classList.remove('hidden');
            } else {
                customDateRangeEl.classList.add('hidden');
                updateDashboard(); // Update dashboard when view changes from custom
            }
        });

        // Event listener for apply custom date filter button
        applyDateFilterBtn.addEventListener('click', () => {
             if (!currentUser) return; // Only filter if logged in
             if (startDateEl.value && endDateEl.value) {
                 updateDashboard();
             } else {
                 showMessage('customDateRangeMissing', 'red'); // Using message key
             }
        });


        // --- Add Entry Logic (Now only for adding new entries) ---
        /**
         * Populates the category dropdown based on the selected entry type.
         * @param {HTMLElement} typeDropdownElement - The select element for the entry type.
         * @param {HTMLElement} categoryDropdownElement - The select element for the category.
         * @param {string} selectedCategory - The category to pre-select (optional).
         */
        function populateCategoryDropdown(typeDropdownElement, categoryDropdownElement, selectedCategory = '') {
             const entryType = typeDropdownElement.value; // Get type from the type dropdown element
             const categories = defaultCategories[entryType] || [];
             categoryDropdownElement.innerHTML = categories.map(cat =>
                 `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`
             ).join('');
        }

        /**
         * Resets the Add Entry form fields.
         */
        function resetAddEntryForm() {
            entryAmountEl.value = '';
            entryNotesEl.value = '';
            entryDateEl.valueAsDate = new Date(); // Set date to today
            entryTypeEl.value = 'income'; // Reset type to income
            populateCategoryDropdown(entryTypeEl, entryCategoryEl); // Repopulate categories for the Add Entry form
        }


        // Event listener for entry type change in Add Entry form
        entryTypeEl.addEventListener('change', () => {
            populateCategoryDropdown(entryTypeEl, entryCategoryEl); // Repopulate categories when type changes
        });

        // Event listener for save new entry button
        saveEntryBtn.addEventListener('click', () => {
             if (!currentUser) {
                 showMessage('Please login to add entries.', 'red'); // Generic message
                 return;
             }

            const type = entryTypeEl.value;
            const amount = parseFloat(entryAmountEl.value);
            const category = entryCategoryEl.value;
            const date = entryDateEl.value;
            const notes = entryNotesEl.value.trim();

            if (!amount || amount <= 0 || !date) {
                showMessage('invalidAmountOrDate', 'red'); // Using message key
                return;
            }

            const newEntry = {
                type: type,
                amount: amount,
                category: category,
                date: new Date(date), // Store as Date object
                notes: notes,
                timestamp: Date.now() + Math.random() // Use Date.now() + random for better uniqueness
            };

            budgetData.push(newEntry);
            saveData();
            showMessage('entrySavedSuccess', 'green'); // Using message key
            // Clear form
            resetAddEntryForm();
            // Update UI
            updateDashboard();
            updateReportTable();
        });

        // Set default date to today's date when the page loads (only if main app is visible)
        // This will now be handled after login in showMainApp or init if already logged in.


        // --- Reports Logic ---
        /**
         * Filters data for the report table based on the selected view and date range.
         * Also calculates summary totals for the filtered data.
         * @returns {object} - Object containing filtered data and summary totals.
         */
        function filterReportDataByView() {
             if (!currentUser) {
                 return { filteredData: [], summary: { totalIncome: 0, totalExpense: 0, balance: 0 } };
             }

             const view = reportViewSelectorEl.value;
             const now = new Date();
             let filteredData = [];

             const start = reportStartDateEl.value ? new Date(reportStartDateEl.value) : null;
             const end = reportEndDateEl.value ? new Date(reportEndDateEl.value) : null;

             // Helper function to check if a date is within a range (inclusive)
            const isDateInRange = (date, start, end) => {
                 if (!start && !end) return true; // No filter
                 if (start && !end) return date >= start;
                 if (!start && end) {
                      // Adjust end date to include the whole day for comparison
                     const adjustedEnd = new Date(end);
                     adjustedEnd.setHours(23, 59, 59, 999);
                     return date >= start && date <= adjustedEnd;
                 }
                 return date >= start && date <= end;
            };

            switch (view) {
                case 'daily':
                    filteredData = budgetData.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === now.getFullYear() &&
                               entryDate.getMonth() === now.getMonth() &&
                               entryDate.getDate() === now.getDate();
                    });
                    break;
                case 'weekly':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);

                    const endOfWeek = new Date(now);
                    endOfWeek.setDate(now.getDate() + (6 - now.getDay()));
                    endOfWeek.setHours(23, 59, 59, 999);

                    filteredData = budgetData.filter(entry => {
                         const entryDate = new Date(entry.date);
                          // Ensure entryDate is a valid Date object before comparison
                         return entryDate instanceof Date && !isNaN(entryDate.getTime()) && entryDate >= startOfWeek && entryDate <= endOfWeek;
                    });
                    break;
                case 'monthly':
                    filteredData = budgetData.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === now.getFullYear() &&
                               entryDate.getMonth() === now.getMonth();
                    });
                    break;
                case 'yearly':
                    filteredData = budgetData.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === now.getFullYear();
                    });
                    break;
                case 'custom':
                     if (start && end) {
                           const adjustedEnd = new Date(end);
                           adjustedEnd.setHours(23, 59, 59, 999);
                           filteredData = budgetData.filter(entry => {
                                const entryDate = new Date(entry.date);
                                 // Ensure entryDate is a valid Date object before comparison
                                return entryDate instanceof Date && !isNaN(entryDate.getTime()) && entryDate >= start && entryDate <= adjustedEnd;
                           });
                      } else {
                         // If custom is selected but dates aren't set, show all
                         filteredData = [...budgetData];
                      }
                     break;
                 case 'all':
                 default:
                    filteredData = [...budgetData]; // Show all
                    break;
            }

             // Sort data by date, newest first
             filteredData.sort((a, b) => b.date - a.date);

             // Calculate summary for filtered data
             let totalIncome = 0;
             let totalExpense = 0;

             filteredData.forEach(entry => {
                 if (entry.type === 'income') {
                     totalIncome += entry.amount;
                 } else if (entry.type === 'expense') {
                     totalExpense += entry.amount;
                 }
             });

             const balance = totalIncome - totalExpense;

             return {
                 filteredData: filteredData,
                 summary: {
                     totalIncome: totalIncome,
                     totalExpense: totalExpense,
                     balance: balance
                 }
             };
        }


        /**
         * Updates the report table and summary with filtered data.
         */
        function updateReportTable() {
             if (!currentUser) {
                 reportTableBodyEl.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center">Please login to view reports.</td></tr>'; // English only message
                 reportTotalIncomeEl.textContent = '0.00';
                 reportTotalExpenseEl.textContent = '0.00';
                 reportBalanceEl.textContent = '0.00';
                 return;
             }

            const { filteredData, summary } = filterReportDataByView();
            reportTableBodyEl.innerHTML = ''; // Clear existing rows

            // Update summary display (English only)
             document.querySelector('#reports-section .glass-card h3').textContent = 'Summary for Selected Period';

             document.querySelector('#reports-section .glass-card div:nth-child(1) p:nth-child(1)').textContent = 'Total Income:';
             reportTotalIncomeEl.textContent = summary.totalIncome.toFixed(2);


             document.querySelector('#reports-section .glass-card div:nth-child(2) p:nth-child(1)').textContent = 'Total Expense:';
             reportTotalExpenseEl.textContent = summary.totalExpense.toFixed(2);


             document.querySelector('#reports-section .glass-card div:nth-child(3) p:nth-child(1)').textContent = 'Balance:';
             reportBalanceEl.textContent = summary.balance.toFixed(2);


            if (filteredData.length === 0) {
                 reportTableBodyEl.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center">No data available for the selected period.</td></tr>'; // English only message
                 return;
            }

            filteredData.forEach(entry => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-800');
                row.dataset.timestamp = entry.timestamp; // Add timestamp data attribute to the row

                const dateCell = document.createElement('td');
                dateCell.classList.add('px-6', 'py-4', 'whitespace-nowrap');
                dateCell.textContent = entry.date.toLocaleDateString(); // Format date

                const typeCell = document.createElement('td');
                typeCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', entry.type === 'income' ? 'text-green-600' : 'text-red-600');
                typeCell.textContent = entry.type.charAt(0).toUpperCase() + entry.type.slice(1); // Capitalize type

                const categoryCell = document.createElement('td');
                categoryCell.classList.add('px-6', 'py-4', 'whitespace-nowrap');
                categoryCell.textContent = entry.category;

                const amountCell = document.createElement('td');
                amountCell.classList.add('px-6', 'py-4', 'whitespace-nowrap');
                amountCell.textContent = entry.amount.toFixed(2);

                const notesCell = document.createElement('td');
                notesCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500', 'dark:text-gray-400');
                notesCell.textContent = entry.notes || '-';

                const actionsCell = document.createElement('td');
                actionsCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right', 'text-sm', 'font-medium');

                // Edit button (English only)
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit'; // English text directly
                editButton.classList.add('text-blue-600', 'hover:text-blue-900', 'focus:outline-none', 'edit-btn'); // Add class for easy selection

                // Delete button (English only)
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete'; // English text directly
                deleteButton.classList.add('text-red-600', 'hover:text-red-900', 'ml-4', 'focus:outline-none', 'delete-btn'); // Add class for easy selection


                actionsCell.appendChild(editButton);
                actionsCell.appendChild(deleteButton);

                row.appendChild(dateCell);
                row.appendChild(typeCell);
                row.appendChild(categoryCell);
                row.appendChild(amountCell);
                row.appendChild(notesCell);
                row.appendChild(actionsCell);

                reportTableBodyEl.appendChild(row);
            });

            // Add event listeners to the newly created buttons
            addReportButtonListeners();
        }

        /**
         * Adds event listeners to the Edit and Delete buttons in the report table.
         */
        function addReportButtonListeners() {
            // Add event listeners for Edit buttons
            reportTableBodyEl.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const row = event.target.closest('tr');
                    const timestamp = parseInt(row.dataset.timestamp);
                    enableInlineEdit(row, timestamp);
                });
            });

            // Add event listeners for Delete buttons
            reportTableBodyEl.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const row = event.target.closest('tr');
                    const entryTimestamp = parseInt(row.dataset.timestamp);
                    console.log("Delete button clicked, timestamp:", entryTimestamp);
                    if (entryTimestamp) {
                        deleteEntry(entryTimestamp);
                    } else {
                        console.error("Timestamp not found on delete button.");
                        showMessage("Could not delete entry. Timestamp missing.", 'red'); // Generic message
                    }
                });
            });
        }

        /**
         * Enables inline editing for a specific table row.
         * @param {HTMLElement} row - The table row element.
         * @param {number} timestamp - The timestamp of the entry being edited.
         */
        function enableInlineEdit(row, timestamp) {
             // Prevent multiple rows from being edited at once
             if (reportTableBodyEl.querySelector('.inline-save-btn')) {
                 showMessage('editingInProgress', 'blue'); // Using message key
                 return;
             }

             const entryToEdit = budgetData.find(entry => entry.timestamp === timestamp);

             if (!entryToEdit) {
                 showMessage('entryNotFound', 'red'); // Using message key
                 return;
             }

             const cells = row.querySelectorAll('td');
             const dateCell = cells[0];
             const typeCell = cells[1];
             const categoryCell = cells[2];
             const amountCell = cells[3];
             const notesCell = cells[4];
             const actionsCell = cells[5];

             // Store original content to restore on cancel (optional, updateTable handles this)
             // row.dataset.originalContent = row.innerHTML;

             // Replace cell content with input fields/selects
             dateCell.innerHTML = `<input type="date" class="inline-edit-field" value="${entryToEdit.date.toISOString().split('T')[0]}">`;

             // Create Type dropdown
             const typeSelect = document.createElement('select');
             typeSelect.classList.add('inline-edit-field', 'inline-edit-type'); // Add class for easy selection
             typeSelect.innerHTML = `
                 <option value="income">Income</option>
                 <option value="expense">Expense</option>
             `;
             typeSelect.value = entryToEdit.type; // Set the current value
             typeCell.innerHTML = ''; // Clear cell before appending
             typeCell.appendChild(typeSelect);

             // Create Category dropdown - populate based on the selected type
             const categorySelect = document.createElement('select');
             categorySelect.classList.add('inline-edit-field', 'inline-edit-category'); // Add class for easy selection
             // Populate the category dropdown based on the current type and pre-select the entry's category
             populateCategoryDropdown(typeSelect, categorySelect, entryToEdit.category);
             categoryCell.innerHTML = ''; // Clear cell before appending
             categoryCell.appendChild(categorySelect);

             // Add event listener to type select to update category dropdown in THIS row
             typeSelect.addEventListener('change', () => {
                 // Pass the categorySelect element from this specific row
                 populateCategoryDropdown(typeSelect, categorySelect);
             });


             amountCell.innerHTML = `<input type="number" class="inline-edit-field" value="${entryToEdit.amount}" min="0" step="0.01">`;
             notesCell.innerHTML = `<textarea class="inline-edit-field" rows="1">${entryToEdit.notes || ''}</textarea>`; // Use textarea for notes


             // Replace action buttons (English only)
             actionsCell.innerHTML = ''; // Clear existing buttons

             const saveButton = document.createElement('button');
             saveButton.textContent = 'Save'; // English text directly
             saveButton.classList.add('text-green-600', 'hover:text-green-900', 'focus:outline-none', 'inline-save-btn');

             const cancelButton = document.createElement('button');
             cancelButton.textContent = 'Cancel'; // English text directly
             cancelButton.classList.add('text-gray-600', 'hover:text-gray-900', 'ml-2', 'focus:outline-none', 'inline-cancel-btn');

             actionsCell.appendChild(saveButton);
             actionsCell.appendChild(cancelButton);

             // Add event listeners to the new inline buttons
             saveButton.addEventListener('click', () => {
                 saveInlineEdit(row, timestamp);
             });

             cancelButton.addEventListener('click', () => {
                 cancelInlineEdit(row);
             });
        }

        /**
         * Saves the changes made during inline editing.
         * @param {HTMLElement} row - The table row element.
         * @param {number} timestamp - The timestamp of the entry being edited.
         */
        function saveInlineEdit(row, timestamp) {
            const cells = row.querySelectorAll('td');
            const dateInput = cells[0].querySelector('input');
            const typeSelect = cells[1].querySelector('select');
            const categorySelect = cells[2].querySelector('select');
            const amountInput = cells[3].querySelector('input');
            const notesTextarea = cells[4].querySelector('textarea');

            const updatedDate = dateInput.value;
            const updatedType = typeSelect.value;
            const updatedCategory = categorySelect.value;
            const updatedAmount = parseFloat(amountInput.value);
            const updatedNotes = notesTextarea.value.trim();

             if (!updatedAmount || updatedAmount <= 0 || !updatedDate) {
                 showMessage('invalidAmountOrDate', 'red'); // Using message key
                 return;
             }


            const entryIndex = budgetData.findIndex(entry => entry.timestamp === timestamp);

            if (entryIndex !== -1) {
                budgetData[entryIndex].date = new Date(updatedDate);
                budgetData[entryIndex].type = updatedType;
                budgetData[entryIndex].category = updatedCategory;
                budgetData[entryIndex].amount = updatedAmount;
                budgetData[entryIndex].notes = updatedNotes;

                saveData();
                showMessage('entryUpdatedSuccess', 'green'); // Using message key
                updateDashboard(); // Update dashboard after editing
                updateReportTable(); // Re-render the table to show updated data and normal buttons

            } else {
                showMessage('entryNotFound', 'red'); // Using message key
                updateReportTable(); // Re-render to reset the row
            }
        }

        /**
         * Cancels the inline editing and restores the original row content.
         * @param {HTMLElement} row - The table row element.
         */
        function cancelInlineEdit(row) {
             // Simply re-render the table to discard changes in the row
             updateReportTable();
             showMessage('editingCancelled', 'blue'); // Using message key
        }


         // Event listener for report view selector change
        reportViewSelectorEl.addEventListener('change', (event) => {
             if (!currentUser) return; // Only filter if logged in
            if (event.target.value === 'custom') {
                reportCustomDateRangeEl.classList.remove('hidden');
            } else {
                reportCustomDateRangeEl.classList.add('hidden');
                updateReportTable(); // Update table when view changes from custom
            }
        });

        // Event listener for apply report custom date filter button
        applyReportFilterBtn.addEventListener('click', () => {
             if (!currentUser) return; // Only filter if logged in
             if (reportStartDateEl.value && reportEndDateEl.value) {
                 updateReportTable();
             } else {
                 showMessage('customReportDateRangeMissing', 'red'); // Using message key
             }
        });

        // Event listener for "Add New Entry" button in Reports section
        addNewEntryReportBtn.addEventListener('click', () => {
             if (!currentUser) {
                 showMessage('Please login to add entries.', 'red'); // Generic message
                 return;
             }
            showSection('add-entry-section'); // Navigate to Add Entry section
        });


        // Event listener for export report button (PDF) - Exports filtered data from Reports section
        exportReportPdfBtn.addEventListener('click', () => {
             if (!currentUser) {
                 showMessage('loginRequiredReports', 'red'); // Using message key
                 return;
             }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text("Budget Report (Filtered)", 14, 16); // Title indicates filtered data

            const tableData = [];
            const headers = ["Date", "Type", "Category", "Amount", "Notes"]; // Actions column is not included in PDF

            const { filteredData, summary } = filterReportDataByView(); // Get filtered data and summary

            if (filteredData.length === 0) {
                 showMessage('dataExportNoData', 'red'); // Using message key
                 return;
            }

            filteredData.forEach(entry => {
                tableData.push([
                    entry.date.toLocaleDateString(),
                    entry.type.charAt(0).toUpperCase() + entry.type.slice(1),
                    entry.category,
                    entry.amount.toFixed(2),
                    entry.notes || '-'
                ]);
            });

            doc.autoTable({
                startY: 20,
                head: [headers],
                body: tableData,
                 theme: 'striped', // Optional: 'striped', 'grid', 'plain'
                 styles: {
                     font: 'Poppins', // Use Poppins font in PDF (if available/supported by jsPDF)
                     fontSize: 10,
                     cellPadding: 3,
                     valign: 'middle',
                     halign: 'left'
                 },
                 headStyles: {
                     fillColor: [41, 128, 185], // Blue header
                     textColor: 255,
                     fontStyle: 'bold'
                 },
                 bodyStyles: {
                     textColor: 50
                 },
                  alternateRowStyles: {
                      fillColor: [245, 245, 245]
                  },
                 didDrawPage: function (data) {
                     // Add page numbers
                     doc.text('Page ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                 }
            });

            // Add summary below the table
            let finalY = doc.lastAutoTable.finalY || 20; // Get the final Y position of the table
            doc.setFontSize(12);
            doc.text(`Summary for Selected Period:`, 14, finalY + 20);
            doc.text(`Total Income: ${summary.totalIncome.toFixed(2)}`, 14, finalY + 30);
            doc.text(`Total Expense: ${summary.totalExpense.toFixed(2)}`, 14, finalY + 40);
            doc.text(`Balance: ${summary.balance.toFixed(2)}`, 14, finalY + 50);


            doc.save('budget_report_filtered.pdf'); // Filename indicates filtered
             showMessage('Filtered report exported as PDF.', 'green'); // Generic message
        });


        // --- Settings Logic ---
        /**
         * Toggles dark mode.
         */
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const isDarkMode = document.body.classList.contains('dark');
            localStorage.setItem('darkMode', isDarkMode);
            // Update chart colors when mode changes
            updateDashboard(); // Re-render charts with new colors
        }

        // Event listener for dark mode toggle
        darkModeToggleEl.addEventListener('change', toggleDarkMode);

        // Check for saved dark mode preference on load
        if (localStorage.getItem('darkMode') === 'true') {
            darkModeToggleEl.checked = true;
            document.body.classList.add('dark');
        }

        // Event listener for reset data button
        resetDataBtn.addEventListener('click', () => {
             if (!currentUser) {
                 showMessage('loginRequiredReset', 'red'); // Using message key
                 return;
             }
            console.log("Reset All Data button clicked."); // Debugging log
            // Using confirm with message key and parameter
            if (confirm(`Are you sure you want to reset all your budget data for user ${currentUser}? This action cannot be undone.`)) {
                console.log("Confirmation accepted. Proceeding with data reset."); // Debugging log
                budgetData = []; // Clear the array in memory
                console.log("budgetData array cleared:", budgetData); // Debugging log

                // Explicitly remove the item from local storage for the current user
                localStorage.removeItem(dataStoragePrefix + currentUser);
                console.log(`localStorage item "${dataStoragePrefix + currentUser}" removed.`); // Debugging log

                // Although removeItem should be enough, let's also save an empty array
                saveData(); // Save the empty array to localStorage (will do nothing if currentUser is null)
                console.log("saveData called after clearing localStorage."); // Debugging log


                updateDashboard(); // Update dashboard after reset
                updateReportTable(); // Update report table after reset
                console.log("UI updated after reset."); // Debugging log
                showMessage('dataResetSuccess', 'green', { username: currentUser }); // Using message key with parameter
            } else {
                console.log("Reset cancelled by user."); // Debugging log
            }
        });

        /**
         * Filters data based on the selected view and date range in the Settings export section.
         * Also calculates summary totals for the filtered data.
         * @returns {object} - Object containing filtered data and summary totals.
         */
        function filterExportDataByView() {
             if (!currentUser) {
                 return { filteredData: [], summary: { totalIncome: 0, totalExpense: 0, balance: 0 } };
             }

            const view = exportViewSelectorEl.value;
            const now = new Date();
            let filteredData = [];

            const start = exportStartDateEl.value ? new Date(exportStartDateEl.value) : null;
            const end = exportEndDateEl.value ? new Date(exportEndDateEl.value) : null;

             // Helper function to check if a date is within a range (inclusive)
            const isDateInRange = (date, start, end) => {
                 if (!start && !end) return true; // No filter
                 if (start && !end) return date >= start;
                 if (!start && end) {
                      // Adjust end date to include the whole day for comparison
                     const adjustedEnd = new Date(end);
                     adjustedEnd.setHours(23, 59, 59, 999);
                     return date >= start && date <= adjustedEnd;
                 }
                 return date >= start && date <= end;
            };

            switch (view) {
                case 'daily':
                    filteredData = budgetData.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === now.getFullYear() &&
                               entryDate.getMonth() === now.getMonth() &&
                               entryDate.getDate() === now.getDate();
                    });
                    break;
                case 'weekly':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);

                    const endOfWeek = new Date(now);
                    endOfWeek.setDate(now.getDate() + (6 - now.getDay()));
                    endOfWeek.setHours(23, 59, 59, 999);

                    filteredData = budgetData.filter(entry => {
                         const entryDate = new Date(entry.date);
                          // Ensure entryDate is a valid Date object before comparison
                         return entryDate instanceof Date && !isNaN(entryDate.getTime()) && entryDate >= startOfWeek && entryDate <= endOfWeek;
                    });
                    break;
                case 'monthly':
                    filteredData = budgetData.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === now.getFullYear() &&
                               entryDate.getMonth() === now.getMonth();
                    });
                    break;
                case 'yearly':
                    filteredData = budgetData.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === now.getFullYear();
                    });
                    break;
                case 'custom':
                     if (start && end) {
                          const adjustedEnd = new Date(end);
                          adjustedEnd.setHours(23, 59, 59, 999);
                          filteredData = budgetData.filter(entry => {
                               const entryDate = new Date(entry.date);
                                // Ensure entryDate is a valid Date object before comparison
                               return entryDate instanceof Date && !isNaN(entryDate.getTime()) && entryDate >= start && entryDate <= adjustedEnd;
                           });
                      } else {
                         // If custom is selected but dates aren't set, show all
                         filteredData = [...budgetData];
                     }
                    break;
                case 'all':
                default:
                    filteredData = [...budgetData]; // Show all
                    break;
            }

             // Sort data by date, newest first for consistent export order
             filteredData.sort((a, b) => b.date - a.date);

             // Calculate summary for filtered data
             let totalIncome = 0;
             let totalExpense = 0;

             filteredData.forEach(entry => {
                 if (entry.type === 'income') {
                     totalIncome += entry.amount;
                 } else if (entry.type === 'expense') {
                     totalExpense += entry.amount;
                 }
             });

             const balance = totalIncome - totalExpense;

             return {
                 filteredData: filteredData,
                 summary: {
                     totalIncome: totalIncome,
                     totalExpense: totalExpense,
                     balance: balance
                 }
             };
        }


        // Event listener for export data button (JSON) - Now exports filtered data with summary
        exportJsonBtn.addEventListener('click', () => {
             if (!currentUser) {
                 showMessage('loginRequiredData', 'red'); // Using message key
                 return;
             }
            const { filteredData, summary } = filterExportDataByView();

             if (filteredData.length === 0) {
                 showMessage('dataExportNoData', 'red'); // Using message key
                 return;
             }

            // Combine filtered data and summary into a single object for JSON export
            const dataToExport = {
                filteredEntries: filteredData,
                summary: summary
            };

            const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget_data_filtered_${currentUser}.json`; // Indicate filtered data and user
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
             showMessage('dataExportJsonSuccess', 'green'); // Using message key
        });

         /**
          * Exports filtered budget data to a PDF file (Settings section) with summary.
          */
         exportAllPdfBtn.addEventListener('click', () => { // This button now exports filtered data
              if (!currentUser) {
                 showMessage('loginRequiredData', 'red'); // Using message key
                 return;
             }
             const { filteredData, summary } = filterExportDataByView();

             if (filteredData.length === 0) {
                 showMessage('dataExportNoData', 'red'); // Using message key
                 return;
             }

             const { jsPDF } = window.jspdf;
             const doc = new jsPDF();

             doc.text("Budget Data Report", 14, 16); // Generic title for settings export

             const tableData = [];
             const headers = ["Date", "Type", "Category", "Amount", "Notes"];

             filteredData.forEach(entry => {
                 tableData.push([
                     entry.date.toLocaleDateString(),
                     entry.type.charAt(0).toUpperCase() + entry.type.slice(1),
                     entry.category,
                     entry.amount.toFixed(2),
                     entry.notes || '-'
                 ]);
             });

             doc.autoTable({
                 startY: 20,
                 head: [headers],
                 body: tableData,
                  theme: 'striped',
                  styles: {
                      font: 'Poppins',
                      fontSize: 10,
                      cellPadding: 3,
                      valign: 'middle',
                      halign: 'left'
                  },
                  headStyles: {
                      fillColor: [41, 128, 185],
                      textColor: 255,
                      fontStyle: 'bold'
                  },
                  bodyStyles: {
                      textColor: 50
                  },
                  alternateRowStyles: {
                      fillColor: [245, 245, 245]
                  },
                 didDrawPage: function (data) {
                     // Add page numbers
                     doc.text('Page ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                 }
             });

             // Add summary below the table
             let finalY = doc.lastAutoTable.finalY || 20; // Get the final Y position of the table
             doc.setFontSize(12);
             doc.text(`Summary for Selected Period:`, 14, finalY + 20);
             doc.text(`Total Income: ${summary.totalIncome.toFixed(2)}`, 14, finalY + 30);
             doc.text(`Total Expense: ${summary.totalExpense.toFixed(2)}`, 14, finalY + 40);
             doc.text(`Balance: ${summary.balance.toFixed(2)}`, 14, finalY + 50);


             doc.save(`budget_data_report_${currentUser}.pdf`); // Generic filename with user
              showMessage('dataExportPdfSuccess', 'green'); // Using message key
         });


         /**
          * Exports filtered budget data to an Excel (.xlsx) file with summary.
          */
         exportExcelBtn.addEventListener('click', () => {
              if (!currentUser) {
                 showMessage('loginRequiredData', 'red'); // Using message key
                 return;
             }
             const { filteredData, summary } = filterExportDataByView();

             if (filteredData.length === 0) {
                 showMessage('dataExportNoData', 'red'); // Using message key
                 return;
             }

             const formattedData = filteredData.map(entry => ({
                 Date: entry.date.toLocaleDateString(),
                 Type: entry.type.charAt(0).toUpperCase() + entry.type.slice(1),
                 Category: entry.category,
                 Amount: entry.amount, // Keep as number for Excel
                 Notes: entry.notes || ''
             }));

             // Add summary rows
             const summaryRows = [
                 {}, // Empty row for spacing
                 { Date: 'Summary:', Type: '', Category: '', Amount: '', Notes: '' },
                 { Date: 'Total Income:', Type: '', Category: '', Amount: summary.totalIncome, Notes: '' },
                 { Date: 'Total Expense:', Type: '', Category: '', Amount: summary.totalExpense, Notes: '' },
                 { Date: 'Balance:', Type: '', Category: '', Amount: summary.balance, Notes: '' }
             ];

             const dataWithSummary = [...formattedData, ...summaryRows];


             const worksheet = XLSX.utils.json_to_sheet(dataWithSummary);
             const workbook = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(workbook, worksheet, "Budget Data");

             // Write the workbook and trigger download
             XLSX.writeFile(workbook, `budget_data_filtered_${currentUser}.xlsx`); // Indicate filtered data and user
             showMessage('dataExportExcelSuccess', 'green'); // Using message key
         });

         /**
          * Exports filtered budget data to a CSV (.csv) file with summary.
          */
         exportCsvBtn.addEventListener('click', () => {
              if (!currentUser) {
                 showMessage('loginRequiredData', 'red'); // Using message key
                 return;
             }
             const { filteredData, summary } = filterExportDataByView();

             if (filteredData.length === 0) {
                 showMessage('dataExportNoData', 'red'); // Using message key
                 return;
             }

             const formattedData = filteredData.map(entry => ({
                 Date: entry.date.toLocaleDateString(),
                 Type: entry.type.charAt(0).toUpperCase() + entry.type.slice(1),
                 Category: entry.category,
                 Amount: entry.amount.toFixed(2), // Format for CSV
                 Notes: entry.notes || ''
             }));

              // Add summary rows for CSV
             const summaryRows = [
                 {}, // Empty row for spacing
                 { Date: 'Summary:', Type: '', Category: '', Amount: '', Notes: '' },
                 { Date: 'Total Income:', Type: '', Category: '', Amount: summary.totalIncome.toFixed(2), Notes: '' },
                 { Date: 'Total Expense:', Type: '', Category: '', Amount: summary.totalExpense.toFixed(2), Notes: '' },
                 { Date: 'Balance:', Type: '', Category: '', Amount: summary.balance.toFixed(2), Notes: '' }
             ];

              const dataWithSummary = [...formattedData, ...summaryRows];


             const worksheet = XLSX.utils.json_to_sheet(dataWithSummary);

             // Convert worksheet to CSV string
             const csvData = XLSX.utils.sheet_to_csv(worksheet);

             const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `budget_data_filtered_${currentUser}.csv`; // Indicate filtered data and user
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
             URL.revokeObjectURL(url);

             showMessage('dataExportCsvSuccess', 'green'); // Using message key
         });


        // Event listener for import data button (JSON)
        importJsonBtn.addEventListener('click', () => {
             if (!currentUser) {
                 showMessage('loginRequiredImport', 'red'); // Using message key
                 return;
             }
             const file = importJsonFileEl.files[0];
             if (!file) {
                 showMessage('dataImportJsonFileMissing', 'red'); // Using message key
                 return;
             }

             const reader = new FileReader();
             reader.onload = (event) => {
                 try {
                     const importedData = JSON.parse(event.target.result);

                     // Check if the imported data is the new format (with filteredEntries and summary)
                     const isNewFormat = importedData && importedData.filteredEntries && importedData.summary;

                     let dataToImport = [];
                     if (isNewFormat) {
                         dataToImport = importedData.filteredEntries; // Extract the entries
                     } else if (Array.isArray(importedData)) {
                         dataToImport = importedData; // Assume it's the old array format
                     } else {
                          showMessage('dataImportInvalidJson', 'red'); // Using message key
                          return;
                     }


                     // Basic validation: check if it's an array and has expected properties
                     if (Array.isArray(dataToImport) && dataToImport.every(entry =>
                         typeof entry === 'object' &&
                         'type' in entry && typeof entry.amount === 'number' && 'category' in entry && 'date' in entry
                     )) {
                          // Convert date strings back to Date objects and validate
                          const validatedData = dataToImport.map(entry => {
                               try {
                                   const date = new Date(entry.date);
                                   if (isNaN(date.getTime())) {
                                       console.warn('Skipping entry with invalid date during JSON import:', entry);
                                       return null; // Mark for removal
                                   }
                                   // Add timestamp if missing during import
                                   if (entry.timestamp === undefined) {
                                       entry.timestamp = Date.now() + Math.random(); // Add a unique-ish timestamp
                                   }
                                   return { ...entry, date: date };
                               } catch (e) {
                                   console.warn('Skipping entry with date parsing error during JSON import:', entry, e);
                                   return null; // Mark for removal
                               }
                          }).filter(entry => entry !== null); // Remove invalid entries

                         // Append imported data to existing data for the current user
                         budgetData = [...budgetData, ...validatedData];


                         saveData();
                         updateDashboard();
                         updateReportTable();
                         showMessage('dataImportSuccess', 'green', { count: validatedData.length }); // Using message key with parameter
                     } else {
                         showMessage('dataImportInvalidJsonFields', 'red'); // Using message key
                     }
                 } catch (e) {
                     showMessage('dataImportJsonError', 'red'); // Using message key
                     console.error(e);
                 } finally {
                     importJsonFileEl.value = ''; // Clear the file input
                 }
             };
             reader.readAsText(file);
        });

        /**
         * Imports data from an Excel (.xlsx) or CSV (.csv) file.
         */
        importExcelCsvBtn.addEventListener('click', () => {
             if (!currentUser) {
                 showMessage('loginRequiredImport', 'red'); // Using message key
                 return;
             }
            const file = importExcelCsvFileEl.files[0];
            if (!file) {
                showMessage('dataImportExcelCsvFileMissing', 'red'); // Using message key
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0]; // Get the first sheet
                    const worksheet = workbook.Sheets[sheetName];

                    // Convert sheet to JSON array
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    // Validate and format the imported data, skipping summary rows if present
                    const importedData = jsonData.map(row => {
                        // Assuming column headers are 'Date', 'Type', 'Category', 'Amount', 'Notes'
                        const dateValue = row['Date'];
                        const type = row['Type'] ? String(row['Type']).toLowerCase() : '';
                        const category = row['Category'] ? String(row['Category']) : '';
                        const amount = parseFloat(row['Amount']);
                        const notes = row['Notes'] ? String(row['Notes']) : '';

                        // Skip rows that look like summary rows (e.g., starting with "Summary:")
                        if (String(dateValue).toLowerCase().startsWith('summary:')) {
                            console.log('Skipping potential summary row during import:', row);
                            return null;
                        }


                        // Basic validation
                        if (!dateValue || !type || !category || isNaN(amount) || amount <= 0 || (type !== 'income' && type !== 'expense')) {
                            console.warn('Skipping invalid row during import:', row);
                            return null; // Skip invalid rows
                        }

                         // Attempt to parse date - handle different formats
                         let date = null;
                         if (typeof dateValue === 'number') {
                             // If it's a number, assume it's an Excel date number
                             date = XLSX.SSF.parse_date_code(dateValue);
                             date = new Date(date.y, date.m - 1, date.d); // Convert to Date object
                         } else {
                             // Otherwise, try parsing as a string
                             date = new Date(dateValue);
                         }

                         // Final date validation
                         if (!date || isNaN(date.getTime())) {
                              console.warn('Skipping row with unparseable date during import:', row);
                              return null; // Skip if date is still invalid
                         }


                        return {
                            type: type,
                            amount: amount,
                            category: category,
                            date: date,
                            notes: notes,
                            timestamp: Date.now() + Math.random() // Assign a new unique-ish timestamp on import
                        };
                    }).filter(entry => entry !== null); // Remove skipped entries

                    // Append imported data to existing data for the current user
                    budgetData = [...budgetData, ...importedData];
                    saveData();
                    updateDashboard();
                    updateReportTable();
                    showMessage('dataImportSuccess', 'green', { count: importedData.length }); // Using message key with parameter

                } catch (e) {
                    showMessage('dataImportExcelCsvError', 'red'); // Using message key
                    console.error(e);
                } finally {
                     importExcelCsvFileEl.value = ''; // Clear the file input
                }
            };

            // Read the file based on its type
            if (file.name.endsWith('.csv')) {
                 reader.readAsText(file); // Read CSV as text
            } else { // Assume .xlsx
                 reader.readAsArrayBuffer(file); // Read Excel as ArrayBuffer
            }
        });

        // Event listener for export view selector change in Settings
        exportViewSelectorEl.addEventListener('change', (event) => {
            if (event.target.value === 'custom') {
                exportCustomDateRangeEl.classList.remove('hidden');
            } else {
                exportCustomDateRangeEl.classList.add('hidden');
            }
            // No need to update anything visually here, filtering happens on export button click
        });


        // --- Profile Logic (NEW) ---

        /**
         * Handles the password change process.
         */
        function changePassword() {
             if (!currentUser) {
                 showMessage('loginRequiredEditProfile', 'red'); // Using message key
                 return;
             }

             const currentPassword = currentPasswordEl.value;
             const newPassword = newPasswordEl.value;
             const confirmNewPassword = confirmNewPasswordEl.value;

             if (!currentPassword || !newPassword || !confirmNewPassword) {
                 showMessage('passwordChangeFieldsEmpty', 'red'); // Using message key
                 return;
             }

             if (newPassword !== confirmNewPassword) {
                 showMessage('passwordsMismatch', 'red'); // Using message key
                 return;
             }

             if (!isPasswordStrong(newPassword)) {
                  showMessage('passwordWeak', 'red'); // Using message key
                  return;
             }

             const users = getUsers();
             const userIndex = users.findIndex(user => user.username === currentUser);

             if (userIndex !== -1) {
                 const user = users[userIndex];
                 const enteredCurrentPasswordHash = hashPassword(currentPassword, user.salt);

                 if (enteredCurrentPasswordHash === user.password) {
                     // Current password is correct, proceed with changing password
                     const newSalt = generateSalt(); // Generate a new salt for the new password
                     const newHashedPassword = hashPassword(newPassword, newSalt);

                     user.password = newHashedPassword;
                     user.salt = newSalt; // Update the salt

                     saveUsers(users);
                     showMessage('passwordChangeSuccess', 'green'); // Using message key
                     // Clear password fields
                     currentPasswordEl.value = '';
                     newPasswordEl.value = '';
                     confirmNewPasswordEl.value = '';

                 } else {
                     showMessage('passwordChangeIncorrectCurrent', 'red'); // Using message key
                 }
             } else {
                 // This case should ideally not happen if currentUser is set correctly
                 showMessage('Error: User not found.', 'red'); // Generic message
             }
        }

        // Event listener for change password button
        changePasswordBtn.addEventListener('click', changePassword);


        // --- Utility Functions ---
        /**
         * Updates placeholder text for English.
         */
         function updatePlaceholders() { // Removed lang parameter
             const placeholders = {
                 'login-username': 'Enter your username',
                 'login-password': 'Enter your password',
                 'register-username': 'Choose a username',
                 'register-password': 'Create a password',
                 'register-confirm-password': 'Confirm your password',
                 'security-a1': 'Enter your answer',
                 'security-a2': 'Enter your answer',
                 'security-a3': 'Enter your answer',
                 'recover-username': 'Enter your username',
                 'recover-a1': 'Enter your answer',
                 'recover-a2': 'Enter your answer',
                 'recover-a3': 'Enter your answer',
                 'recover-new-password': 'Create a new password',
                 'recover-confirm-new-password': 'Confirm your new password',
                 'entry-amount': 'Enter amount',
                 'entry-notes': 'Add notes',
                 'current-password': 'Enter current password',
                 'new-password': 'Enter new password',
                 'confirm-new-password': 'Confirm new password'
             };

             for (const id in placeholders) {
                 const element = document.getElementById(id);
                 if (element) {
                     element.placeholder = placeholders[id]; // Set English placeholder directly
                 }
             }

              // Security question labels in recovery step 2 are now handled in findAccountForRecovery
         }


        /**
         * Displays a temporary message box.
         * @param {string} messageKey - The key for the message to display (e.g., 'entrySavedSuccess').
         * @param {string} type - 'green' for success, 'red' for error, 'blue' for info.
         * @param {object} [params={}] - Optional parameters to replace in the message string (e.g., { username: 'Ali' }).
         */
        function showMessage(messageKey, type = 'blue', params = {}) {
             // currentLang is not needed anymore, always use 'en' messages
             const currentLang = 'en'; // Hardcoded to English

             // Define messages for English only
             const messages = {
                 en: {
                     entrySavedSuccess: 'Entry saved successfully!',
                     entryUpdatedSuccess: 'Entry updated successfully!',
                     entryDeletedSuccess: 'Entry deleted successfully!',
                     entryNotFound: 'Error: Could not find entry.',
                     invalidAmountOrDate: 'Please enter a valid amount and date.',
                     loginRequired: 'Please login to access the app.',
                     loginRequiredReports: 'Please login to export reports.',
                     loginRequiredData: 'Please login to export data.',
                     loginRequiredImport: 'Please login to import data.',
                     loginRequiredReset: 'Please login to reset data.',
                     loginRequiredProfile: 'Please login to view your profile.',
                     loginRequiredEditProfile: 'Please login to edit your profile.',

                     usernameTaken: 'This username is already taken.',
                     usernameTakenByOther: 'This username is already taken by another account.',
                     usernameInvalidFormat: 'Username must contain letters, numbers, and allowed symbols (!@#$%^&*()_+.-).',
                     usernameEmpty: 'Username cannot be empty.',
                     passwordsMismatch: 'Passwords do not match.',
                     passwordWeak: 'Password must be at least 8 characters long and include lowercase, uppercase, numbers, and symbols.',
                     accountCreatedSuccess: 'Account created successfully! You can now login.',
                     loginFailed: 'Incorrect password.',
                     userNotFound: 'No account found with this username.',

                     recoveryFindAccountFailed: 'No account found with this username.',
                     recoveryAnswersVerified: 'Answers verified. You can now set a new password.',
                     recoveryAnswersIncorrect: 'Incorrect answers. Please try again.',
                     recoveryProcessNotInitiated: 'Recovery process not initiated. Please start again.',
                     passwordResetSuccess: 'Password reset successfully! You can now login with your new password.',
                     passwordChangeSuccess: 'Password changed successfully!',
                     passwordChangeIncorrectCurrent: 'Incorrect current password.',
                     passwordChangeFieldsEmpty: 'Please fill in all password fields.',

                     dataResetConfirm: `Are you sure you want to reset all your budget data for user ${params.username}? This action cannot be undone.`,
                     dataResetSuccess: `All data for user ${params.username} has been reset.`,
                     dataExportNoData: 'No data for the selected period to export.',
                     dataExportJsonSuccess: 'Filtered data exported as JSON.',
                     dataExportPdfSuccess: 'Filtered data exported as PDF.',
                     dataExportExcelSuccess: 'Filtered data exported as Excel (.xlsx).',
                     dataExportCsvSuccess: 'Filtered data exported as CSV (.csv).',
                     dataImportJsonFileMissing: 'Please select a JSON file to import.',
                     dataImportInvalidJson: 'Invalid JSON file format.',
                     dataImportInvalidJsonFields: 'Invalid JSON file format or missing required fields.',
                     dataImportJsonError: 'Error parsing JSON file.',
                     dataImportSuccess: `Successfully imported ${params.count} entries.`,
                     dataImportExcelCsvFileMissing: 'Please select an Excel (.xlsx) or CSV (.csv) file to import.',
                     dataImportExcelCsvError: 'Error importing file. Please ensure it is a valid Excel (.xlsx) or CSV (.csv) file with correct columns (Date, Type, Category, Amount, Notes).',

                     editingInProgress: 'Please save or cancel the current edit before editing another entry.',
                     editingCancelled: 'Editing cancelled.',
                     usernameEditCancelled: 'Username editing cancelled.',
                     usernameNotChanged: 'Username was not changed.',
                     customDateRangeMissing: 'Please select both start and end dates for custom view.',
                     customReportDateRangeMissing: 'Please select both start and end dates for custom report view.',
                     duplicateSecurityQuestions: 'Please select three different security questions.',
                     missingSecurityQuestions: 'Please fill in all fields, including security questions.',
                     answerSecurityQuestions: 'Please answer all security questions.',
                     setNewPasswordMessage: 'Set your new password.',
                     enterUsernameToRecover: 'Enter your username to find your security questions.',
                     verifyAnswersMessage: 'Answer your security questions.',
                     // Add other messages as needed
                 }
             };

             let messageToShow = messages[currentLang][messageKey] || messageKey; // Fallback to key if message not found

             // Replace parameters in the message string
             for (const param in params) {
                 const regex = new RegExp(`\\{${param}\\}`, 'g'); // Use regex to replace all occurrences
                 messageToShow = messageToShow.replace(regex, params[param]);
             }


             messageTextEl.textContent = messageToShow;
             messageBoxEl.className = `fixed bottom-4 right-4 p-4 rounded-md shadow-lg transition-opacity duration-300 ease-in-out`; // Reset classes

             if (type === 'green') {
                 messageBoxEl.classList.add('bg-green-500', 'text-white');
             } else if (type === 'red') {
                 messageBoxEl.classList.add('bg-red-500', 'text-white');
             } else { // blue
                 messageBoxEl.classList.add('bg-blue-500', 'text-white');
             }

             messageBoxEl.classList.remove('hidden');
             messageBoxEl.classList.add('opacity-100');

             setTimeout(() => {
                 messageBoxEl.classList.remove('opacity-100');
                 messageBoxEl.classList.add('opacity-0');
                 setTimeout(() => {
                     messageBoxEl.classList.add('hidden');
                 }, 300); // Hide after fade out
             }, 3000); // Show for 3 seconds
        }


        // --- Initialization ---
        /**
         * Initializes the application on page load.
         */
        function init() {
            // Removed language loading:
            // const savedLang = localStorage.getItem(languageStorageKey) || 'en';
            // languageSelectEl.value = savedLang;
            // setLanguage(savedLang);

            // Always set placeholders for English on init
            updatePlaceholders();


            // Check if user is already logged in from sessionStorage
            currentUser = sessionStorage.getItem('currentUser');

            if (currentUser) {
                showMainApp(); // If logged in, show the main app
                // Set default date inputs to today after showing main app
                const today = new Date().toISOString().split('T')[0];
                startDateEl.value = today;
                endDateEl.value = today;
                reportStartDateEl.value = today;
                reportEndDateEl.value = today;
                 exportStartDateEl.value = today;
                 exportEndDateEl.value = today;
            } else {
                showAuthSection('login-section'); // If not logged in, show login
            }

             // Set default date to today's date for Add Entry form (even if hidden)
             entryDateEl.valueAsDate = new Date();

             // Check for saved dark mode preference on load
             if (localStorage.getItem('darkMode') === 'true') {
                 darkModeToggleEl.checked = true;
                 document.body.classList.add('dark');
             }
        }

        // Run initialization when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', init);

        // Add event listener for window resize to update charts
        window.addEventListener('resize', () => {
            // Chart.js handles responsiveness automatically with options.responsive = true
            // No manual redraw needed unless the container size logic is complex
        });

    </script>

</body>
</html>
